# 前端修改提示词：成品链接监控 - 使用滑动窗口波动率

## 📋 修改概述

后端API接口 `/api/finished/link/monitor/list` 的返回数据结构已更新，现在使用**滑动窗口波动率（Sliding Volatility）**替代之前的**变化指数（Change Index）**。需要修改前端代码以适配新的数据结构。

---

## 🔄 API接口信息

**接口路径：** `GET /api/finished/link/monitor/list`

**查询参数：**
- `shopID` (必填): 店铺ID
- `shopName` (必填): 店铺名称  
- `date` (可选): 日期，格式 YYYY-MM-DD

**响应格式：**
```json
{
  "success": true,
  "message": "查询成功",
  "data": [
    {
      "id": "商品ID",
      "name": "商品名称",
      "image": "商品主图URL",
      "visitorsAvg": [30日均值, 15日均值, 7日均值, 3日均值, 1日均值],
      "visitorsVolatility": [
        {
          "window": 1,
          "direction": "+",
          "strength": 15.25,
          "level": "轻微"
        },
        {
          "window": 3,
          "direction": "+",
          "strength": 28.50,
          "level": "轻微"
        },
        {
          "window": 7,
          "direction": "-",
          "strength": 42.80,
          "level": "一般"
        },
        {
          "window": 15,
          "direction": "+",
          "strength": 35.20,
          "level": "一般"
        },
        {
          "window": 30,
          "direction": "+",
          "strength": 25.50,
          "level": "轻微"
        }
      ],
      "adCostAvg": [30日均值, 15日均值, 7日均值, 3日均值, 1日均值],
      "adCostVolatility": [
        // ... 5个窗口的波动率数据
      ],
      "salesAvg": [30日均值, 15日均值, 7日均值, 3日均值, 1日均值],
      "salesVolatility": [
        // ... 5个窗口的波动率数据
      ],
      "warningLevel": "严重" | "一般" | "轻微" | "正常",
      "warningMessages": [
        "访客数波动较大，趋势上升，变化强度45.20%，需要关注趋势变化",
        "销售额波动剧烈，趋势下降，变化强度78.50%，风险较高，建议及时处理"
      ]
    }
  ]
}
```

---

## ⚠️ 数据结构变化

### 旧数据结构（已废弃）
```typescript
{
  visitorsChangeIndex: Array<{
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }>;  // 数组长度5，对应30/15/7/3/1天
  adCostChangeIndex: Array<{...}>;
  salesChangeIndex: Array<{...}>;
}
```

### 新数据结构
```typescript
{
  visitorsVolatility: Array<{
    window: number;           // 滑动窗口天数：1, 3, 7, 15, 30
    direction: '+' | '-';     // 变化方向：+上升，-下降
    strength: number;         // 变化强度：0-100
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';  // 变化等级
  }>;  // 数组长度5，包含5个不同窗口的波动率
  adCostVolatility: Array<{...}>;
  salesVolatility: Array<{...}>;
}
```

**关键区别：**
- 旧版：数组索引对应时间维度（索引0=30天，索引1=15天...）
- 新版：数组元素包含 `window` 字段，明确标识窗口大小

---

## 🎨 UI显示要求

### 1. 滑动窗口波动率显示格式

每个指标（访客数、广告花费、销售额）需要显示5个滑动窗口的波动率：
- **窗口大小**：1天、3天、7天、15天、30天
- **方向图标**：`+` 显示上升箭头（↑）或绿色，`-` 显示下降箭头（↓）或红色
- **强度数值**：显示为百分比，保留2位小数，例如 `25.50%`
- **等级标签**：显示中文等级（极小/轻微/一般/明显/剧烈）

**示例显示：**
```
访客数滑动窗口波动率：
1天：↑ 15.25% [轻微]  3天：↑ 28.50% [轻微]  7天：↓ 42.80% [一般]  15天：↑ 35.20% [一般]  30天：↑ 25.50% [轻微]
```

### 2. 颜色方案（重要：5个窗口需要不同颜色）

**窗口颜色分配：**
- **1天**：红色 `#ef4444` 或 `#dc2626`（最紧急）
- **3天**：橙色 `#f97316` 或 `#f59e0b`（短期）
- **7天**：黄色 `#eab308` 或 `#facc15`（中期）
- **15天**：蓝色 `#3b82f6` 或 `#60a5fa`（中长期）
- **30天**：深蓝色 `#1e40af` 或 `#2563eb`（长期）

**变化等级颜色：**
- **极小**：灰色 `#6b7280` - 基本稳定
- **轻微**：绿色 `#10b981` - 轻微波动
- **一般**：黄色 `#f59e0b` - 中等波动，值得关注
- **明显**：橙色 `#f97316` - 波动较大，需要关注
- **剧烈**：红色 `#ef4444` - 波动剧烈，风险高

**方向颜色：**
- **上升（+）**：绿色系 `#10b981` 或 `#22c55e`
- **下降（-）**：红色系 `#ef4444` 或 `#dc2626`

### 3. 警告信息显示

在商品卡片或详情区域显示 `warningMessages` 数组中的警告提示语：
- 使用警告样式（黄色/橙色背景，或带图标）
- 每条警告信息单独一行显示
- 如果没有警告信息，不显示警告区域

### 4. 预警等级显示

`warningLevel` 字段显示预警等级，使用对应的颜色：
- **严重**：红色背景/边框
- **一般**：橙色背景/边框
- **轻微**：黄色背景/边框
- **正常**：绿色背景/边框或灰色

---

## 📝 需要修改的文件和位置

### 1. TypeScript 类型定义文件

**查找位置：** `types/` 或 `interfaces/` 或组件文件中的类型定义

**需要修改：**
```typescript
// 旧类型（删除或注释）
interface FinishedLinkMonitorItem {
  visitorsChangeIndex: Array<{
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }>;
  adCostChangeIndex: Array<{...}>;
  salesChangeIndex: Array<{...}>;
  // ...
}

// 新类型（替换）
interface FinishedLinkMonitorItem {
  visitorsVolatility: Array<{
    window: number;           // 1, 3, 7, 15, 30
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }>;
  adCostVolatility: Array<{
    window: number;
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }>;
  salesVolatility: Array<{
    window: number;
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }>;
  // ...
}
```

### 2. 数据展示组件

**需要修改的地方：**

1. **访客数变化指数显示** → **访客数滑动窗口波动率显示**
   - 旧：`item.visitorsChangeIndex[index]`（通过索引访问）
   - 新：`item.visitorsVolatility.find(v => v.window === windowSize)`（通过window字段查找）

2. **广告花费变化指数显示** → **广告花费滑动窗口波动率显示**
   - 旧：`item.adCostChangeIndex[index]`
   - 新：`item.adCostVolatility.find(v => v.window === windowSize)`

3. **销售额变化指数显示** → **销售额滑动窗口波动率显示**
   - 旧：`item.salesChangeIndex[index]`
   - 新：`item.salesVolatility.find(v => v.window === windowSize)`

### 3. 示例代码片段

```tsx
// 窗口配置
const WINDOWS = [1, 3, 7, 15, 30];
const WINDOW_COLORS = {
  1: '#ef4444',   // 红色
  3: '#f97316',   // 橙色
  7: '#eab308',   // 黄色
  15: '#3b82f6',   // 蓝色
  30: '#1e40af'   // 深蓝色
};

// 等级颜色
const LEVEL_COLORS = {
  '极小': '#6b7280',
  '轻微': '#10b981',
  '一般': '#f59e0b',
  '明显': '#f97316',
  '剧烈': '#ef4444'
};

// 渲染滑动窗口波动率的组件函数
const renderVolatility = (
  volatility: {
    window: number;
    direction: '+' | '-';
    strength: number;
    level: '极小' | '轻微' | '一般' | '明显' | '剧烈';
  }
) => {
  const windowColor = WINDOW_COLORS[volatility.window];
  const directionColor = volatility.direction === '+' ? '#10b981' : '#ef4444';
  const levelColor = LEVEL_COLORS[volatility.level];

  return (
    <div style={{ 
      display: 'inline-flex', 
      alignItems: 'center', 
      marginRight: '12px',
      padding: '4px 8px',
      borderRadius: '4px',
      backgroundColor: `${windowColor}10`,
      border: `1px solid ${windowColor}40`
    }}>
      <span style={{ 
        color: windowColor, 
        fontWeight: 'bold',
        marginRight: '4px'
      }}>
        {volatility.window}天
      </span>
      <span style={{ color: directionColor, marginRight: '4px' }}>
        {volatility.direction === '+' ? '↑' : '↓'}
      </span>
      <span style={{ color: directionColor }}>
        {volatility.strength.toFixed(2)}%
      </span>
      <span style={{ 
        color: levelColor,
        marginLeft: '6px',
        padding: '2px 6px',
        borderRadius: '4px',
        backgroundColor: `${levelColor}20`,
        fontSize: '12px'
      }}>
        [{volatility.level}]
      </span>
    </div>
  );
};

// 在组件中使用
<div>
  <div style={{ marginBottom: '8px' }}>
    <strong>访客数滑动窗口波动率：</strong>
  </div>
  {item.visitorsVolatility.map((volatility) => (
    <React.Fragment key={volatility.window}>
      {renderVolatility(volatility)}
    </React.Fragment>
  ))}
</div>

<div style={{ marginTop: '16px' }}>
  <div style={{ marginBottom: '8px' }}>
    <strong>广告花费滑动窗口波动率：</strong>
  </div>
  {item.adCostVolatility.map((volatility) => (
    <React.Fragment key={volatility.window}>
      {renderVolatility(volatility)}
    </React.Fragment>
  ))}
</div>

<div style={{ marginTop: '16px' }}>
  <div style={{ marginBottom: '8px' }}>
    <strong>销售额滑动窗口波动率：</strong>
  </div>
  {item.salesVolatility.map((volatility) => (
    <React.Fragment key={volatility.window}>
      {renderVolatility(volatility)}
    </React.Fragment>
  ))}
</div>
```

### 4. 查找特定窗口的波动率

如果需要查找特定窗口的波动率（例如1天窗口），使用 `find` 方法：

```tsx
// 查找1天窗口的波动率
const volatility1Day = item.visitorsVolatility.find(v => v.window === 1);

// 查找3天窗口的波动率
const volatility3Day = item.visitorsVolatility.find(v => v.window === 3);

// 使用
if (volatility1Day) {
  console.log(`1天窗口：${volatility1Day.direction}${volatility1Day.strength}% [${volatility1Day.level}]`);
}
```

---

## ✅ 检查清单

修改完成后，请确认：

- [ ] TypeScript 类型定义已更新（`visitorsChangeIndex` → `visitorsVolatility`）
- [ ] 所有使用 `visitorsChangeIndex`、`adCostChangeIndex`、`salesChangeIndex` 的地方已替换
- [ ] 使用 `find` 方法通过 `window` 字段查找特定窗口的波动率
- [ ] 滑动窗口波动率正确显示窗口大小、方向、强度、等级
- [ ] 5个窗口使用了不同的颜色区分（1天红、3天橙、7天黄、15天蓝、30天深蓝）
- [ ] 变化等级使用了对应的颜色
- [ ] 警告信息（`warningMessages`）已正确显示
- [ ] 预警等级（`warningLevel`）使用了对应的颜色
- [ ] 没有 TypeScript 类型错误
- [ ] 没有控制台错误
- [ ] UI 显示美观，易于区分不同窗口

---

## 📌 注意事项

1. **窗口字段：**
   - 数组中的每个元素都有 `window` 字段，值为 1、3、7、15、30
   - 不要使用数组索引来访问，而是使用 `find` 方法通过 `window` 字段查找

2. **数组顺序：**
   - 数组顺序可能不固定，始终使用 `find` 方法查找特定窗口
   - 不要假设数组索引对应特定窗口

3. **波动强度数值：**
   - 范围：0-100
   - 显示时保留2位小数
   - 单位：百分比（%）

4. **变化等级含义：**
   - **极小**（0-10）：基本稳定，几乎无波动
   - **轻微**（10-30）：轻微波动，不影响判断
   - **一般**（30-60）：中等波动，值得关注
   - **明显**（60-80）：波动较大，需要关注趋势
   - **剧烈**（80-100）：波动非常大，风险高

5. **方向含义：**
   - `+`：窗口内平均趋势上升
   - `-`：窗口内平均趋势下降

6. **滑动窗口说明：**
   - 滑动窗口从最新数据往前取指定天数的数据
   - 例如：1天窗口取最后1天的数据，30天窗口取最后30天的数据
   - 如果数据不足窗口大小，使用所有可用数据

---

## 🔄 与旧版变化指数的区别

| 特性 | 变化指数（旧版） | 滑动窗口波动率（新版） |
|------|----------------|---------------------|
| 数据结构 | 数组索引对应时间维度 | 数组元素包含window字段 |
| 访问方式 | `array[index]` | `array.find(v => v.window === size)` |
| 计算范围 | 固定时间段（30/15/7/3/1天） | 滑动窗口（从最新数据往前） |
| 方向判断 | 整个时间段平均变化率 | 窗口内平均变化率 |
| 强度计算 | 最大振幅（max-min） | 平均绝对偏差（MAD） |
| 窗口标识 | 通过数组索引推断 | 明确的window字段 |

---

## 🎯 预期效果

修改完成后，页面应该：
- 清晰显示每个指标的5个滑动窗口波动率（1/3/7/15/30天）
- 使用不同颜色区分5个窗口（1天红、3天橙、7天黄、15天蓝、30天深蓝）
- 使用颜色和图标直观显示变化方向和等级
- 在明显位置显示警告信息
- 整体视觉效果美观，信息层次清晰
- 能够快速识别不同时间尺度的波动情况

---

## 📚 参考

- 滑动窗口波动率计算逻辑：基于平均绝对偏差（MAD）方法
- 强度映射：`strength = min(MAD * 200, 100)`
- 等级划分：与变化指数相同的阈值体系

