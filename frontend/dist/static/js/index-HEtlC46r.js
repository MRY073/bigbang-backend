var B=(H,P,v)=>new Promise((F,U)=>{var E=f=>{try{k(v.next(f))}catch(K){U(K)}},d=f=>{try{k(v.throw(f))}catch(K){U(K)}},k=f=>f.done?F(f.value):Promise.resolve(f.value).then(E,d);k((v=v.apply(H,P)).next())});import{d as ce,a as C,M as ie,m as ue,k as _,e as r,f as s,w as u,g as y,i as de,h as b,F as R,l as G,b as q,j as $,u as N,gS as re,A as _e,B as pe,a9 as S,t as T,gT as A,fL as h,x as ve,gU as me,fM as ge,_ as ye}from"./index-BBIx6VGs.js";import{g as fe,u as ke,d as he,a as Ce}from"./productItems-CqnzHQh-.js";const be={class:"custom-category-page"},$e={class:"filter-section"},Ve={class:"filter-left"},xe={class:"table-wrapper"},ze={key:1,class:"no-image"},Se=["data-key"],Ue={key:0,class:"edit-wrapper"},Ee={class:"edit-actions"},De=["onClick"],Be={key:0},Fe={key:1,class:"empty-text"},Ke=["data-key"],Ie={key:0,class:"edit-wrapper"},Oe={class:"edit-actions"},Me=["onClick"],Ne={key:0},Pe={key:1,class:"empty-text"},je=["data-key"],Le={key:0,class:"edit-wrapper"},Te={class:"edit-actions"},Ae=["onClick"],qe={key:0},He={key:1,class:"empty-text"},Re=["data-key"],Ge={key:0,class:"edit-wrapper"},Je={class:"edit-actions"},Qe=["onClick"],We={key:0},Xe={key:1,class:"empty-text"},Ye={key:0,class:"pagination-wrapper"},Ze=ce({name:"CustomCategory",__name:"index",setup(H){const P=[{label:"Modern Nest|泰国",value:"1489850435"},{label:"shop07|泰国",value:"1638595255"}],v=C(""),F=ie([]),U=C(!1),E=C(!1),d=C({}),k=C(1),f=C(20),K=[10,20,50,100],I=C(0),g=C({}),O=C([]),V=C(""),J=()=>B(null,null,function*(){if(v.value)try{const l=yield Ce({shopID:v.value});if(l.success&&Array.isArray(l.data))X(W(l.data));else throw new Error(l.error||l.message||"获取分类失败")}catch(l){console.error("获取自定义分类选项失败:",l),h.error((l==null?void 0:l.message)||"获取自定义分类选项失败")}}),Q=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],W=l=>l.map(e=>{var a,n,o,c,p;return typeof e=="string"?e:e&&typeof e=="object"&&(p=(c=(o=(n=(a=e.label)!=null?a:e.name)!=null?n:e.value)!=null?o:e.key)!=null?c:e.id)!=null?p:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean),X=l=>{if(!l.length)return;const e=new Set(O.value.map(n=>n.value));let a=!1;l.forEach(n=>{const o=n.trim();!o||e.has(o)||(O.value.push({label:o,value:o}),e.add(o),a=!0)}),a&&O.value.sort((n,o)=>n.label.localeCompare(o.label,"zh-Hans-CN"))};function Y(l="加载中..."){return ge.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}const M=(l=!0)=>B(null,null,function*(){if(!v.value){h.warning("请先选择店铺");return}l&&(k.value=1),E.value=!0;const e=Y("拉取数据中...");try{const a=P.find(c=>c.value===v.value);if(!a)throw new Error("店铺信息不存在");const n={shopID:v.value,shopName:a.label,page:k.value,pageSize:f.value};V.value&&(n.customCategory=V.value);const o=yield fe(n);if(o.success&&o.data){const c=V.value?o.data.filter(p=>Q.some(D=>{const m=p[D];return typeof m=="string"&&m.includes(V.value)})):o.data;F.value=c,g.value={},d.value={},I.value=V.value?c.length:o.total||o.data.length,l&&h.success(o.message||`拉取成功，共 ${I.value} 条数据`)}else throw new Error(o.error||o.message||"拉取失败")}catch(a){console.error("拉取数据失败:",a),h.error((a==null?void 0:a.message)||"拉取失败，请稍后重试"),F.value=[],I.value=0}finally{e.close(),E.value=!1}}),Z=()=>{v.value&&(k.value=1,M())},w=()=>{O.value=[],V.value="",v.value&&J()};ue(()=>{});const j=(l,e)=>B(null,null,function*(){const a=`${l.id||l.product_id}`;g.value[a]||(g.value[a]={});const n=e;d.value[a]||(d.value[a]={}),n in d.value[a]||(d.value[a][n]=l[n]),g.value[a][e]=!0,yield ve();const o=document.querySelector(`.editable-cell[data-field="${e}"][data-key="${a}"]`);if(o){const c=o.querySelector("input");c&&(c.focus(),c.select())}}),x=(l,e)=>{var o;const a=`${l.id||l.product_id}`;g.value[a]&&(g.value[a][e]=!1);const n=e;d.value[a]&&n in d.value[a]&&(l[n]=(o=d.value[a][n])!=null?o:null,delete d.value[a][n],Object.keys(d.value[a]).length===0&&delete d.value[a])},z=(l,e)=>B(null,null,function*(){var n,o;const a=`${l.id||l.product_id}`;if(!l.id&&!l.product_id){h.warning("商品ID不存在，无法保存");return}U.value=!0;try{const c={[e]:l[e]||null},p=l.id||l.product_id,D=yield ke(p,c);if(D.success){h.success("保存成功"),g.value[a]&&(g.value[a][e]=!1);const m=e;d.value[a]&&m in d.value[a]&&(delete d.value[a][m],Object.keys(d.value[a]).length===0&&delete d.value[a])}else{h.error(D.message||"保存失败");const m=e;d.value[a]&&m in d.value[a]&&(l[m]=(n=d.value[a][m])!=null?n:null),g.value[a]&&(g.value[a][e]=!1)}}catch(c){console.error("保存失败:",c),h.error((c==null?void 0:c.message)||"保存失败，请稍后重试");const p=e;d.value[a]&&p in d.value[a]&&(l[p]=(o=d.value[a][p])!=null?o:null),g.value[a]&&(g.value[a][e]=!1)}finally{U.value=!1}}),L=(l,e)=>{var n;const a=`${l.id||l.product_id}`;return((n=g.value[a])==null?void 0:n[e])===!0},ee=l=>B(null,null,function*(){try{yield me.confirm(`确定要删除商品 "${l.product_name}" 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),U.value=!0;const e=l.id||l.product_id,a=yield he(e);a.success?(h.success("删除成功"),yield M()):h.error(a.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),h.error((e==null?void 0:e.message)||"删除失败，请稍后重试"))}finally{U.value=!1}}),te=l=>{k.value=l,v.value&&M(!1)},ae=l=>{f.value=l,k.value=1,v.value&&M(!1)};return(l,e)=>{const a=b("el-option"),n=b("el-select"),o=b("el-icon"),c=b("el-button"),p=b("el-table-column"),D=b("el-image"),m=b("el-input"),le=b("el-table"),se=b("el-pagination"),oe=b("el-card"),ne=pe("loading");return r(),_("div",be,[s(oe,{class:"category-card",shadow:"never"},{header:u(()=>[...e[5]||(e[5]=[y("div",{class:"card-header"},[y("span",{class:"card-title"},"自定义分类管理")],-1)])]),default:u(()=>[y("div",$e,[y("div",Ve,[s(n,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=t=>v.value=t),placeholder:"请选择店铺",clearable:"",style:{width:"250px"},onChange:w},{default:u(()=>[(r(),_(R,null,G(P,t=>s(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),s(n,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),placeholder:"请选择自定义分类",clearable:"",style:{width:"220px"},onChange:Z},{default:u(()=>[(r(!0),_(R,null,G(O.value,t=>(r(),q(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(c,{type:"primary",disabled:!v.value,loading:E.value,onClick:e[2]||(e[2]=()=>M())},{default:u(()=>[s(o,null,{default:u(()=>[s(N(re))]),_:1}),e[6]||(e[6]=$(" 拉取商品 ",-1))]),_:1},8,["disabled","loading"])])]),y("div",xe,[_e((r(),q(le,{data:F.value,stripe:"",border:"",style:{width:"100%"},"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)",textAlign:"center"}},{default:u(()=>[s(p,{prop:"product_id",label:"商品ID",width:"150",align:"center","show-overflow-tooltip":""}),s(p,{prop:"product_name",label:"商品名称",width:"200",align:"center","show-overflow-tooltip":""}),s(p,{label:"商品图片",width:"120",align:"center"},{default:u(({row:t})=>[t.product_image?(r(),q(D,{key:0,src:t.product_image,"preview-src-list":[t.product_image],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"},"preview-teleported":!0},null,8,["src","preview-src-list"])):(r(),_("span",ze,"暂无图片"))]),_:1}),s(p,{label:"自定义分类1",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_1","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_1")?(r(),_("div",Ue,[s(m,{modelValue:t.custom_category_1,"onUpdate:modelValue":i=>t.custom_category_1=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_1"),["enter"]),S(i=>x(t,"custom_category_1"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Ee,[s(c,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_1")},{default:u(()=>[...e[7]||(e[7]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(c,{link:"",size:"small",onClick:i=>x(t,"custom_category_1")},{default:u(()=>[...e[8]||(e[8]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(r(),_("div",{key:1,class:"cell-content",onClick:i=>j(t,"custom_category_1")},[t.custom_category_1?(r(),_("span",Be,T(t.custom_category_1),1)):(r(),_("span",Fe,"点击编辑")),s(o,{class:"edit-icon"},{default:u(()=>[s(N(A))]),_:1})],8,De))],8,Se)]),_:1}),s(p,{label:"自定义分类2",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_2","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_2")?(r(),_("div",Ie,[s(m,{modelValue:t.custom_category_2,"onUpdate:modelValue":i=>t.custom_category_2=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_2"),["enter"]),S(i=>x(t,"custom_category_2"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Oe,[s(c,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_2")},{default:u(()=>[...e[9]||(e[9]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(c,{link:"",size:"small",onClick:i=>x(t,"custom_category_2")},{default:u(()=>[...e[10]||(e[10]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(r(),_("div",{key:1,class:"cell-content",onClick:i=>j(t,"custom_category_2")},[t.custom_category_2?(r(),_("span",Ne,T(t.custom_category_2),1)):(r(),_("span",Pe,"点击编辑")),s(o,{class:"edit-icon"},{default:u(()=>[s(N(A))]),_:1})],8,Me))],8,Ke)]),_:1}),s(p,{label:"自定义分类3",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_3","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_3")?(r(),_("div",Le,[s(m,{modelValue:t.custom_category_3,"onUpdate:modelValue":i=>t.custom_category_3=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_3"),["enter"]),S(i=>x(t,"custom_category_3"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Te,[s(c,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_3")},{default:u(()=>[...e[11]||(e[11]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(c,{link:"",size:"small",onClick:i=>x(t,"custom_category_3")},{default:u(()=>[...e[12]||(e[12]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(r(),_("div",{key:1,class:"cell-content",onClick:i=>j(t,"custom_category_3")},[t.custom_category_3?(r(),_("span",qe,T(t.custom_category_3),1)):(r(),_("span",He,"点击编辑")),s(o,{class:"edit-icon"},{default:u(()=>[s(N(A))]),_:1})],8,Ae))],8,je)]),_:1}),s(p,{label:"自定义分类4",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_4","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_4")?(r(),_("div",Ge,[s(m,{modelValue:t.custom_category_4,"onUpdate:modelValue":i=>t.custom_category_4=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_4"),["enter"]),S(i=>x(t,"custom_category_4"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Je,[s(c,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_4")},{default:u(()=>[...e[13]||(e[13]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(c,{link:"",size:"small",onClick:i=>x(t,"custom_category_4")},{default:u(()=>[...e[14]||(e[14]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(r(),_("div",{key:1,class:"cell-content",onClick:i=>j(t,"custom_category_4")},[t.custom_category_4?(r(),_("span",We,T(t.custom_category_4),1)):(r(),_("span",Xe,"点击编辑")),s(o,{class:"edit-icon"},{default:u(()=>[s(N(A))]),_:1})],8,Qe))],8,Re)]),_:1}),s(p,{label:"操作",width:"120",align:"center",fixed:"right"},{default:u(({row:t})=>[s(c,{link:"",type:"danger",size:"small",onClick:i=>ee(t)},{default:u(()=>[...e[15]||(e[15]=[$(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ne,E.value]])]),I.value>0?(r(),_("div",Ye,[s(se,{"current-page":k.value,"onUpdate:currentPage":e[3]||(e[3]=t=>k.value=t),"page-size":f.value,"onUpdate:pageSize":e[4]||(e[4]=t=>f.value=t),"page-sizes":K,total:I.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:te,onSizeChange:ae},null,8,["current-page","page-size","total"])])):de("",!0)]),_:1})])}}}),at=ye(Ze,[["__scopeId","data-v-d5ef4786"]]);export{at as default};
