var T=(q,U,y)=>new Promise((O,k)=>{var p=b=>{try{w(y.next(b))}catch(M){k(M)}},F=b=>{try{w(y.throw(b))}catch(M){k(M)}},w=b=>b.done?O(b.value):Promise.resolve(b.value).then(p,F);w((y=y.apply(q,U)).next())});import{d as De,M as we,a as v,p as B,n as Ve,m as Se,k as h,e as g,f as i,w as m,g as c,i as te,h as D,F as ae,l as le,b as j,u as xe,j as P,v as ke,t as L,q as ne,fJ as f,fL as Me,_ as He}from"./index-C6l8RhZe.js";import{g as Te,o as Fe,u as Ue}from"./products-C3rGUI67.js";import{g as Oe}from"./productItems-DVrKzOBL.js";import{s as $e,g as A,D as Ee}from"./shops-B4eWs2OP.js";const Pe={class:"product-stage-page"},Ne={class:"card-header"},ze={class:"left"},Ie={class:"actions"},Le={class:"filter-section"},Be={class:"filter-inputs"},je={class:"filter-buttons"},Ae={class:"table-wrapper"},qe={class:"sort-icon"},Je={key:0},Re={key:1},Ge={key:2},Ke={class:"cell-center"},Qe={key:1,class:"dash"},We={class:"cell-center"},Xe=["onClick"],Ze={class:"cell-center"},et=["onClick"],tt={class:"cell-center"},at=["src"],lt={key:1,class:"no-img"},nt={class:"save-actions"},st={class:"stage-editor"},ot={class:"time-picker-group"},rt={class:"stage-editor"},it={class:"time-picker-group"},dt={class:"stage-editor"},ct={class:"time-picker-group"},ut={class:"stage-editor"},mt={class:"time-picker-group"},pt={class:"cell-center"},gt={key:0},_t={key:1,class:"dash"},ft={class:"offline-actions"},vt={key:0,class:"pagination-wrapper"},ht=De({name:"ProductStageManual",__name:"index",setup(q){const U={testing:"测款阶段",potential:"潜力阶段",product:"成品阶段",abandoned:"放弃阶段"},y=we([]),O=v(!1),k=v("all"),p=v(Ee),F=v(""),w=v(""),b=v(""),M=v(""),Y=v(1),$=v(20),se=[10,20,50,100,200],C=v("default"),J=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],E=v([]),H=v(""),N=v({});function oe(l="加载中..."){return Me.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}function re(l){return l.map(e=>{var s,n,a,r,o;return typeof e=="string"?e:e&&typeof e=="object"&&(o=(r=(a=(n=(s=e.label)!=null?s:e.name)!=null?n:e.value)!=null?a:e.key)!=null?r:e.id)!=null?o:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean)}function R(l){if(!l.length)return;const e=new Set(E.value.map(n=>n.value));let s=!1;l.forEach(n=>{const a=n.trim();!a||e.has(a)||(E.value.push({label:a,value:a}),e.add(a),s=!0)}),s&&E.value.sort((n,a)=>n.label.localeCompare(a.label,"zh-Hans-CN"))}function ie(l){const e=[];return l.forEach(s=>{J.forEach(n=>{const a=s[n];if(typeof a=="string"){const r=a.trim();r&&e.push(r)}})}),e}function G(){return T(this,null,function*(){try{const l={};p.value&&(l.shopID=p.value);const e=yield Oe(l);if(e.success&&Array.isArray(e.data))R(re(e.data));else throw new Error(e.error||e.message||"获取自定义分类失败")}catch(l){console.error("获取自定义分类失败:",l)}})}function V(l){if(!l)return null;try{const e=new Date(l),s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),d=String(e.getSeconds()).padStart(2,"0");return`${s}-${n}-${a} ${r}:${o}:${d}`}catch(e){return null}}function S(l){if(!l||l.trim()==="")return null;try{const e=new Date(l);return isNaN(e.getTime())?null:e.toISOString()}catch(e){return null}}function de(l,e){if(!l.start_time||!l.end_time||!e.start_time||!e.end_time)return!1;try{const s=S(l.start_time),n=S(l.end_time),a=S(e.start_time),r=S(e.end_time);if(!s||!n||!a||!r)return!1;const o=new Date(s),d=new Date(n),_=new Date(a),x=new Date(r);return o>=_&&o<=x||d>=_&&d<=x||o<=_&&d>=x}catch(s){return!1}}function ce(l){const e=["testing","potential","product","abandoned"],s=[];for(let n=0;n<e.length;n++)for(let a=n+1;a<e.length;a++){const r=e[n],o=e[a],d=l[`${r}_stage`],_=l[`${o}_stage`];de(d,_)&&s.push([r,o])}return s}function K(l){const e=new Date,s=["abandoned","product","potential","testing"];for(const n of s){const a=l[`${n}_stage`];if(a!=null&&a.start_time&&(a!=null&&a.end_time))try{const r=S(a.start_time),o=S(a.end_time);if(r&&o){const d=new Date(r),_=new Date(o);if(!isNaN(d.getTime())&&!isNaN(_.getTime())&&d<=e&&e<=_)return n}}catch(r){}}return null}function ue(l){y.value=l.map(e=>{var r,o,d,_,x,z,t,u;const s=J.map(I=>{var ee;return(ee=e[I])!=null?ee:""}).map(I=>typeof I=="string"?I.trim():"").filter(Boolean),n=s.join(" / "),a={product_id:e.product_id,product_name:e.product_name,product_image:e.product_image,testing_stage:{start_time:V(((r=e.testing_stage)==null?void 0:r.start_time)||null),end_time:V(((o=e.testing_stage)==null?void 0:o.end_time)||null)},potential_stage:{start_time:V(((d=e.potential_stage)==null?void 0:d.start_time)||null),end_time:V(((_=e.potential_stage)==null?void 0:_.end_time)||null)},product_stage:{start_time:V(((x=e.product_stage)==null?void 0:x.start_time)||null),end_time:V(((z=e.product_stage)==null?void 0:z.end_time)||null)},abandoned_stage:{start_time:V(((t=e.abandoned_stage)==null?void 0:t.start_time)||null),end_time:V(((u=e.abandoned_stage)==null?void 0:u.end_time)||null)},savingFlags:{testing:!1,potential:!1,product:!1,abandoned:!1},currentStage:null,customCategories:s,customCategoriesText:n,isOfflining:!1,isOfflined:!1};return a.currentStage=K(a),a})}function me(){return T(this,null,function*(){if(!p.value){f.warning("请先选择店铺");return}N.value={},O.value=!0;const l=oe("拉取数据中...");try{const e=A(p.value);if(!e)throw new Error("店铺信息不存在");const s={shopID:p.value,shopName:e.label};H.value&&(s.customCategory=H.value);const n=yield Te(s);if(n.success&&n.data)ue(n.data),R(ie(n.data)),Y.value=1,f.success(n.message||`数据拉取成功，共 ${y.value.length} 条`);else throw console.error("数据验证失败:",{success:n.success,hasData:!!n.data,error:n.error,message:n.message}),new Error(n.error||n.message||"查询失败")}catch(e){console.error("拉取数据失败:",e),f.error((e==null?void 0:e.message)||"网络连接失败，请检查网络后重试"),y.value=[]}finally{l.close(),O.value=!1}})}function pe(l,e,s,n){return T(this,null,function*(){const a=A(p.value);if(!a)throw new Error("店铺信息不存在");const r=S(s),o=S(n),d=yield Ue({product_id:l,shopID:p.value,shopName:a.label,stage_type:e,start_time:r,end_time:o});if(!d.success)throw new Error(d.error||d.message||"更新失败")})}function ge(l){return T(this,null,function*(){if(!p.value){f.warning("请先选择店铺");return}const e=y.value.find(a=>a.product_id===l);if(!e){f.error("商品不存在");return}const s=ce(e);if(s.length>0){const a=s.map(([r,o])=>`${U[r]}和${U[o]}`).join("、");f.error(`时间段重叠：${a}的时间段存在重叠，请检查后重试`);return}const n=["testing","potential","product","abandoned"];n.forEach(a=>{e.savingFlags[a]=!0});try{const a=n.map(r=>{const o=e[`${r}_stage`];return pe(l,r,o.start_time,o.end_time)});yield Promise.all(a),e.currentStage=K(e),f.success("保存成功")}catch(a){console.error("保存阶段失败:",a),f.error((a==null?void 0:a.message)||"保存失败，请检查网络后重试")}finally{n.forEach(a=>{e.savingFlags[a]=!1})}})}const Q=B(()=>{const l=y.value;if(l.length===0)return[];let e;if(k.value==="all")e=l;else{const a=k.value;e=l.filter(r=>{const o=r[`${a}_stage`],d=(o==null?void 0:o.start_time)&&(o==null?void 0:o.end_time),_=r.currentStage===a;return d||_})}if(H.value){const a=H.value.trim();e=e.filter(r=>r.customCategories.some(o=>o.trim()===a))}const s=b.value.trim();if(s){const a=s.toLowerCase();e=e.filter(r=>r.product_id.toLowerCase().includes(a))}const n=M.value.trim();if(n){const a=n.toLowerCase();e=e.filter(r=>r.product_name.toLowerCase().includes(a))}return C.value!=="default"&&(e=e.slice().sort((a,r)=>{const o=a.currentStage||"",d=r.currentStage||"";return!o&&!d?0:o?d?C.value==="asc"?o.localeCompare(d):d.localeCompare(o):-1:1})),e}),_e=B(()=>{const l=Q.value,e=(Y.value-1)*$.value,s=e+$.value;return l.slice(e,s)}),W=B(()=>Q.value.length);function fe(l){Y.value=l}function ve(l){$.value=l,Y.value=1}function X(l){return T(this,null,function*(){try{if(navigator.clipboard&&navigator.clipboard.writeText)yield navigator.clipboard.writeText(l);else{const e=document.createElement("textarea");e.value=l,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}f.success("已复制到剪贴板")}catch(e){f.error("复制失败")}})}function he(){b.value=F.value,M.value=w.value,Y.value=1}function ye(){F.value="",w.value="",b.value="",M.value="",Y.value=1}function be(){C.value==="default"?C.value="asc":C.value==="asc"?C.value="desc":C.value="default",Y.value=1}function Ye(){Y.value=1}function Z(){E.value=[],H.value="",N.value={},p.value&&G(),Y.value=1}function Ce(l){return T(this,null,function*(){if(!p.value){f.warning("请先选择店铺");return}const e=y.value.find(s=>s.product_id===l);if(!e){f.error("商品不存在");return}if(!e.isOfflined){e.isOfflining=!0;try{if(!A(p.value))throw new Error("店铺信息不存在");const n=yield Fe({product_id:l});if(n.success)N.value[l]=!0,f.success(n.message||"下架成功");else throw new Error(n.error||n.message||"下架失败")}catch(s){console.error("下架商品失败:",s),f.error((s==null?void 0:s.message)||"下架失败，请检查网络后重试"),e.isOfflining=!1}}})}return Ve(p,()=>{Z()}),Se(()=>{p.value&&G()}),(l,e)=>{const s=D("el-option"),n=D("el-select"),a=D("el-button"),r=D("el-input"),o=D("el-table-column"),d=D("el-date-picker"),_=D("el-table"),x=D("el-pagination"),z=D("el-card");return g(),h("div",Pe,[i(z,{class:"stage-card"},{default:m(()=>[c("div",Ne,[c("div",ze,[i(n,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=t=>k.value=t),placeholder:"筛选阶段",style:{width:"220px"}},{default:m(()=>[i(s,{label:"全部",value:"all"}),i(s,{label:"测款阶段",value:"testing"}),i(s,{label:"潜力阶段",value:"potential"}),i(s,{label:"成品阶段",value:"product"}),i(s,{label:"放弃阶段",value:"abandoned"})]),_:1},8,["modelValue"]),i(n,{modelValue:H.value,"onUpdate:modelValue":e[1]||(e[1]=t=>H.value=t),placeholder:"自定义分类",clearable:"",filterable:"",style:{width:"220px"},onChange:Ye},{default:m(()=>[(g(!0),h(ae,null,le(E.value,t=>(g(),j(s,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),c("div",Ie,[i(n,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),placeholder:"选择店铺",style:{width:"200px","margin-right":"12px"},onChange:Z},{default:m(()=>[(g(!0),h(ae,null,le(xe($e),t=>(g(),j(s,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(a,{type:"primary",loading:O.value,icon:"el-icon-refresh",onClick:me},{default:m(()=>[...e[7]||(e[7]=[P("拉取数据",-1)])]),_:1},8,["loading"])])]),c("div",Le,[c("div",Be,[i(r,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=t=>F.value=t),placeholder:"产品ID",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"]),i(r,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=t=>w.value=t),placeholder:"产品名称",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"])]),c("div",je,[i(a,{type:"primary",onClick:he},{default:m(()=>[...e[8]||(e[8]=[P("筛选",-1)])]),_:1}),i(a,{onClick:ye},{default:m(()=>[...e[9]||(e[9]=[P("取消筛选",-1)])]),_:1})])]),c("div",Ae,[i(_,{data:_e.value,stripe:"",style:{width:"100%"},"row-key":t=>t.product_id,"row-class-name":({row:t})=>t.currentStage==="abandoned"?"row-abandoned":"","max-height":600},{default:m(()=>[i(o,{prop:"currentStage",label:"当前阶段",width:"140",align:"center","header-align":"center",fixed:"left"},{header:m(()=>[c("div",{class:"sortable-header",onClick:be},[e[10]||(e[10]=c("span",null,"当前阶段",-1)),c("span",qe,[C.value==="default"?(g(),h("span",Je,"⇅")):C.value==="asc"?(g(),h("span",Re,"↑")):(g(),h("span",Ge,"↓"))])])]),default:m(({row:t})=>[c("div",Ke,[t.currentStage?(g(),h("span",{key:0,class:ke(`current-badge stage-${t.currentStage}`)},L(U[t.currentStage]||t.currentStage),3)):(g(),h("span",Qe,"-"))])]),_:1}),i(o,{prop:"product_id",label:"产品ID",width:"160",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",We,[c("span",{class:"plain-text",title:"点击复制",onClick:ne(u=>X(t.product_id),["stop"])},L(t.product_id),9,Xe)])]),_:1}),i(o,{prop:"product_name",label:"产品名称",width:"300",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",Ze,[c("span",{class:"plain-text",title:"点击复制",onClick:ne(u=>X(t.product_name),["stop"])},L(t.product_name),9,et)])]),_:1}),i(o,{prop:"product_image",label:"产品主图",width:"120",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",tt,[t.product_image?(g(),h("img",{key:0,src:t.product_image,alt:"主图",class:"thumb"},null,8,at)):(g(),h("div",lt,"无图"))])]),_:1}),i(o,{label:"操作",width:"120",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",nt,[i(a,{type:"primary",size:"small",loading:t.savingFlags.testing||t.savingFlags.potential||t.savingFlags.product||t.savingFlags.abandoned,onClick:u=>ge(t.product_id)},{default:m(()=>[...e[11]||(e[11]=[P("保存",-1)])]),_:1},8,["loading","onClick"])])]),_:1}),i(o,{label:"测款阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",st,[c("div",ot,[i(d,{modelValue:t.testing_stage.start_time,"onUpdate:modelValue":u=>t.testing_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.testing_stage.end_time,"onUpdate:modelValue":u=>t.testing_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"潜力阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",rt,[c("div",it,[i(d,{modelValue:t.potential_stage.start_time,"onUpdate:modelValue":u=>t.potential_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.potential_stage.end_time,"onUpdate:modelValue":u=>t.potential_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"成品阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",dt,[c("div",ct,[i(d,{modelValue:t.product_stage.start_time,"onUpdate:modelValue":u=>t.product_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.product_stage.end_time,"onUpdate:modelValue":u=>t.product_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"放弃阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",ut,[c("div",mt,[i(d,{modelValue:t.abandoned_stage.start_time,"onUpdate:modelValue":u=>t.abandoned_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.abandoned_stage.end_time,"onUpdate:modelValue":u=>t.abandoned_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"自定义分类","min-width":"220",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",pt,[t.customCategoriesText&&t.customCategoriesText.length?(g(),h("span",gt,L(t.customCategoriesText),1)):(g(),h("span",_t,"-"))])]),_:1}),i(o,{label:"操作",width:"120",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",ft,[N.value[t.product_id]?te("",!0):(g(),j(a,{key:0,type:"danger",size:"small",loading:t.isOfflining,onClick:u=>Ce(t.product_id)},{default:m(()=>[...e[12]||(e[12]=[P("下架",-1)])]),_:1},8,["loading","onClick"]))])]),_:1})]),_:1},8,["data","row-key","row-class-name"])]),W.value>0?(g(),h("div",vt,[i(x,{"current-page":Y.value,"onUpdate:currentPage":e[5]||(e[5]=t=>Y.value=t),"page-size":$.value,"onUpdate:pageSize":e[6]||(e[6]=t=>$.value=t),"page-sizes":se,total:W.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:fe,onSizeChange:ve},null,8,["current-page","page-size","total"])])):te("",!0)]),_:1})])}}}),wt=He(ht,[["__scopeId","data-v-b8b745b8"]]);export{wt as default};
