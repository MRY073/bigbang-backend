var O=(J,g,x)=>new Promise((E,P)=>{var r=V=>{try{z(x.next(V))}catch($){P($)}},b=V=>{try{z(x.throw(V))}catch($){P($)}},z=V=>V.done?E(V.value):Promise.resolve(V.value).then(r,b);z((x=x.apply(J,g)).next())});import{d as ve,a as f,M as ge,m as ye,k as _,e as d,f as o,w as c,g as m,i as fe,h as k,F as Q,l as W,b as H,u as F,j as h,gS as ke,A as he,B as Ce,a9 as U,t as L,gT as M,fL as C,x as be,fM as Ve,_ as $e}from"./index-BTtCWf6Z.js";import{g as xe,u as X,a as ze}from"./productItems-DqLsdzLE.js";import{s as De,g as Ne}from"./shops-B4eWs2OP.js";const Se={class:"custom-category-page"},Ue={class:"filter-section"},Ee={class:"filter-left"},Pe={class:"table-wrapper"},Fe={key:1,class:"no-image"},Ie=["data-key"],Ke={key:0,class:"edit-wrapper"},Oe={class:"edit-actions"},Be=["onClick"],Le={key:0},Me={key:1,class:"empty-text"},je=["data-key"],Ae={key:0,class:"edit-wrapper"},Te={class:"edit-actions"},qe=["onClick"],Re={key:0},He={key:1,class:"empty-text"},Ge=["data-key"],Je={key:0,class:"edit-wrapper"},Qe={class:"edit-actions"},We=["onClick"],Xe={key:0},Ye={key:1,class:"empty-text"},Ze=["data-key"],we={key:0,class:"edit-wrapper"},et={class:"edit-actions"},tt=["onClick"],lt={key:0},at={key:1,class:"empty-text"},ot=["onClick"],st=["title"],nt={key:1,class:"empty-text"},ct={key:0,class:"pagination-wrapper"},it={class:"prompt-note-dialog-content"},ut={class:"dialog-tips"},dt={class:"dialog-footer"},rt=2e3,_t=ve({name:"CustomCategory",__name:"index",setup(J){const g=f(""),x=ge([]),E=f(!1),P=f(!1),r=f({}),b=f(1),z=f(20),V=[10,20,50,100],$=f(0),y=f({}),B=f([]),D=f(""),j=f(!1),A=f(null),I=f(""),Y=()=>O(null,null,function*(){if(g.value)try{const l=yield ze({shopID:g.value});if(l.success&&Array.isArray(l.data))ee(w(l.data));else throw new Error(l.error||l.message||"获取分类失败")}catch(l){console.error("获取自定义分类选项失败:",l),C.error((l==null?void 0:l.message)||"获取自定义分类选项失败")}}),Z=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],w=l=>l.map(e=>{var a,n,s,i,p;return typeof e=="string"?e:e&&typeof e=="object"&&(p=(i=(s=(n=(a=e.label)!=null?a:e.name)!=null?n:e.value)!=null?s:e.key)!=null?i:e.id)!=null?p:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean),ee=l=>{if(!l.length)return;const e=new Set(B.value.map(n=>n.value));let a=!1;l.forEach(n=>{const s=n.trim();!s||e.has(s)||(B.value.push({label:s,value:s}),e.add(s),a=!0)}),a&&B.value.sort((n,s)=>n.label.localeCompare(s.label,"zh-Hans-CN"))};function te(l="加载中..."){return Ve.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}const T=(l=!0)=>O(null,null,function*(){if(!g.value){C.warning("请先选择店铺");return}l&&(b.value=1),P.value=!0;const e=te("拉取数据中...");try{const a=Ne(g.value);if(!a)throw new Error("店铺信息不存在");const n={shopID:g.value,shopName:a.label,page:b.value,pageSize:z.value};D.value&&(n.customCategory=D.value);const s=yield xe(n);if(s.success&&s.data){const i=D.value?s.data.filter(p=>Z.some(K=>{const v=p[K];return typeof v=="string"&&v.includes(D.value)})):s.data;x.value=i,y.value={},r.value={},$.value=D.value?i.length:s.total||s.data.length,l&&C.success(s.message||`拉取成功，共 ${$.value} 条数据`)}else throw new Error(s.error||s.message||"拉取失败")}catch(a){console.error("拉取数据失败:",a),C.error((a==null?void 0:a.message)||"拉取失败，请稍后重试"),x.value=[],$.value=0}finally{e.close(),P.value=!1}}),le=()=>{g.value&&(b.value=1,T())},ae=()=>{B.value=[],D.value="",g.value&&Y()};ye(()=>{});const q=(l,e)=>O(null,null,function*(){const a=`${l.id||l.product_id}`;y.value[a]||(y.value[a]={});const n=e;r.value[a]||(r.value[a]={}),n in r.value[a]||(r.value[a][n]=l[n]),y.value[a][e]=!0,yield be();const s=document.querySelector(`.editable-cell[data-field="${e}"][data-key="${a}"]`);if(s){const i=s.querySelector("input");i&&(i.focus(),i.select())}}),N=(l,e)=>{var s;const a=`${l.id||l.product_id}`;y.value[a]&&(y.value[a][e]=!1);const n=e;r.value[a]&&n in r.value[a]&&(l[n]=(s=r.value[a][n])!=null?s:null,delete r.value[a][n],Object.keys(r.value[a]).length===0&&delete r.value[a])},S=(l,e)=>O(null,null,function*(){var n,s;const a=`${l.id||l.product_id}`;if(!l.id&&!l.product_id){C.warning("商品ID不存在，无法保存");return}E.value=!0;try{const i={[e]:l[e]||null},p=l.id||l.product_id,K=yield X(p,i);if(K.success){C.success("保存成功"),y.value[a]&&(y.value[a][e]=!1);const v=e;r.value[a]&&v in r.value[a]&&(delete r.value[a][v],Object.keys(r.value[a]).length===0&&delete r.value[a])}else{C.error(K.message||"保存失败");const v=e;r.value[a]&&v in r.value[a]&&(l[v]=(n=r.value[a][v])!=null?n:null),y.value[a]&&(y.value[a][e]=!1)}}catch(i){console.error("保存失败:",i),C.error((i==null?void 0:i.message)||"保存失败，请稍后重试");const p=e;r.value[a]&&p in r.value[a]&&(l[p]=(s=r.value[a][p])!=null?s:null),y.value[a]&&(y.value[a][e]=!1)}finally{E.value=!1}}),R=(l,e)=>{var n;const a=`${l.id||l.product_id}`;return((n=y.value[a])==null?void 0:n[e])===!0},oe=l=>{b.value=l,g.value&&T(!1)},se=l=>{z.value=l,b.value=1,g.value&&T(!1)},ne=l=>{A.value=l,I.value=l.prompt_note||"",j.value=!0},G=()=>{j.value=!1,A.value=null,I.value=""},ce=()=>O(null,null,function*(){if(!A.value)return;const l=A.value;if(`${l.id||l.product_id}`,!l.id&&!l.product_id){C.warning("商品ID不存在，无法保存");return}E.value=!0;try{const e={prompt_note:I.value.trim()||null},a=l.id||l.product_id,n=yield X(a,e);n.success?(C.success("保存成功"),l.prompt_note=I.value.trim()||null,G()):C.error(n.message||"保存失败")}catch(e){console.error("保存失败:",e),C.error((e==null?void 0:e.message)||"保存失败，请稍后重试")}finally{E.value=!1}}),ie=l=>{if(!l)return"点击编辑";const e=l.trim();return e.length<=50?e:e.substring(0,50)+"..."};return(l,e)=>{const a=k("el-option"),n=k("el-select"),s=k("el-icon"),i=k("el-button"),p=k("el-table-column"),K=k("el-image"),v=k("el-input"),ue=k("el-table"),de=k("el-pagination"),re=k("el-card"),_e=k("el-text"),pe=k("el-dialog"),me=Ce("loading");return d(),_("div",Se,[o(re,{class:"category-card",shadow:"never"},{header:c(()=>[...e[7]||(e[7]=[m("div",{class:"card-header"},[m("span",{class:"card-title"},"自定义分类管理")],-1)])]),default:c(()=>[m("div",Ue,[m("div",Ee,[o(n,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=t=>g.value=t),placeholder:"请选择店铺",clearable:"",style:{width:"250px"},onChange:ae},{default:c(()=>[(d(!0),_(Q,null,W(F(De),t=>(d(),H(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(n,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),placeholder:"请选择自定义分类",clearable:"",style:{width:"220px"},onChange:le},{default:c(()=>[(d(!0),_(Q,null,W(B.value,t=>(d(),H(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(i,{type:"primary",disabled:!g.value,loading:P.value,onClick:e[2]||(e[2]=()=>T())},{default:c(()=>[o(s,null,{default:c(()=>[o(F(ke))]),_:1}),e[8]||(e[8]=h(" 拉取商品 ",-1))]),_:1},8,["disabled","loading"])])]),m("div",Pe,[he((d(),H(ue,{data:x.value,stripe:"",border:"",style:{width:"100%"},"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)",textAlign:"center"}},{default:c(()=>[o(p,{prop:"product_id",label:"商品ID",width:"150",align:"center","show-overflow-tooltip":""}),o(p,{prop:"product_name",label:"商品名称",width:"200",align:"center","show-overflow-tooltip":""}),o(p,{label:"商品图片",width:"120",align:"center"},{default:c(({row:t})=>[t.product_image?(d(),H(K,{key:0,src:t.product_image,"preview-src-list":[t.product_image],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"},"preview-teleported":!0},null,8,["src","preview-src-list"])):(d(),_("span",Fe,"暂无图片"))]),_:1}),o(p,{label:"自定义分类1",width:"200",align:"center"},{default:c(({row:t})=>[m("div",{class:"editable-cell","data-field":"custom_category_1","data-key":`${t.id||t.product_id}`},[R(t,"custom_category_1")?(d(),_("div",Ke,[o(v,{modelValue:t.custom_category_1,"onUpdate:modelValue":u=>t.custom_category_1=u,placeholder:"请输入分类",size:"small",onKeyup:[U(u=>S(t,"custom_category_1"),["enter"]),U(u=>N(t,"custom_category_1"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),m("div",Oe,[o(i,{link:"",type:"primary",size:"small",onClick:u=>S(t,"custom_category_1")},{default:c(()=>[...e[9]||(e[9]=[h(" 保存 ",-1)])]),_:1},8,["onClick"]),o(i,{link:"",size:"small",onClick:u=>N(t,"custom_category_1")},{default:c(()=>[...e[10]||(e[10]=[h(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),_("div",{key:1,class:"cell-content",onClick:u=>q(t,"custom_category_1")},[t.custom_category_1?(d(),_("span",Le,L(t.custom_category_1),1)):(d(),_("span",Me,"点击编辑")),o(s,{class:"edit-icon"},{default:c(()=>[o(F(M))]),_:1})],8,Be))],8,Ie)]),_:1}),o(p,{label:"自定义分类2",width:"200",align:"center"},{default:c(({row:t})=>[m("div",{class:"editable-cell","data-field":"custom_category_2","data-key":`${t.id||t.product_id}`},[R(t,"custom_category_2")?(d(),_("div",Ae,[o(v,{modelValue:t.custom_category_2,"onUpdate:modelValue":u=>t.custom_category_2=u,placeholder:"请输入分类",size:"small",onKeyup:[U(u=>S(t,"custom_category_2"),["enter"]),U(u=>N(t,"custom_category_2"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),m("div",Te,[o(i,{link:"",type:"primary",size:"small",onClick:u=>S(t,"custom_category_2")},{default:c(()=>[...e[11]||(e[11]=[h(" 保存 ",-1)])]),_:1},8,["onClick"]),o(i,{link:"",size:"small",onClick:u=>N(t,"custom_category_2")},{default:c(()=>[...e[12]||(e[12]=[h(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),_("div",{key:1,class:"cell-content",onClick:u=>q(t,"custom_category_2")},[t.custom_category_2?(d(),_("span",Re,L(t.custom_category_2),1)):(d(),_("span",He,"点击编辑")),o(s,{class:"edit-icon"},{default:c(()=>[o(F(M))]),_:1})],8,qe))],8,je)]),_:1}),o(p,{label:"自定义分类3",width:"200",align:"center"},{default:c(({row:t})=>[m("div",{class:"editable-cell","data-field":"custom_category_3","data-key":`${t.id||t.product_id}`},[R(t,"custom_category_3")?(d(),_("div",Je,[o(v,{modelValue:t.custom_category_3,"onUpdate:modelValue":u=>t.custom_category_3=u,placeholder:"请输入分类",size:"small",onKeyup:[U(u=>S(t,"custom_category_3"),["enter"]),U(u=>N(t,"custom_category_3"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),m("div",Qe,[o(i,{link:"",type:"primary",size:"small",onClick:u=>S(t,"custom_category_3")},{default:c(()=>[...e[13]||(e[13]=[h(" 保存 ",-1)])]),_:1},8,["onClick"]),o(i,{link:"",size:"small",onClick:u=>N(t,"custom_category_3")},{default:c(()=>[...e[14]||(e[14]=[h(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),_("div",{key:1,class:"cell-content",onClick:u=>q(t,"custom_category_3")},[t.custom_category_3?(d(),_("span",Xe,L(t.custom_category_3),1)):(d(),_("span",Ye,"点击编辑")),o(s,{class:"edit-icon"},{default:c(()=>[o(F(M))]),_:1})],8,We))],8,Ge)]),_:1}),o(p,{label:"自定义分类4",width:"200",align:"center"},{default:c(({row:t})=>[m("div",{class:"editable-cell","data-field":"custom_category_4","data-key":`${t.id||t.product_id}`},[R(t,"custom_category_4")?(d(),_("div",we,[o(v,{modelValue:t.custom_category_4,"onUpdate:modelValue":u=>t.custom_category_4=u,placeholder:"请输入分类",size:"small",onKeyup:[U(u=>S(t,"custom_category_4"),["enter"]),U(u=>N(t,"custom_category_4"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),m("div",et,[o(i,{link:"",type:"primary",size:"small",onClick:u=>S(t,"custom_category_4")},{default:c(()=>[...e[15]||(e[15]=[h(" 保存 ",-1)])]),_:1},8,["onClick"]),o(i,{link:"",size:"small",onClick:u=>N(t,"custom_category_4")},{default:c(()=>[...e[16]||(e[16]=[h(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),_("div",{key:1,class:"cell-content",onClick:u=>q(t,"custom_category_4")},[t.custom_category_4?(d(),_("span",lt,L(t.custom_category_4),1)):(d(),_("span",at,"点击编辑")),o(s,{class:"edit-icon"},{default:c(()=>[o(F(M))]),_:1})],8,tt))],8,Ze)]),_:1}),o(p,{label:"提示词备注",width:"250",align:"center"},{default:c(({row:t})=>[m("div",{class:"prompt-note-cell",onClick:u=>ne(t)},[t.prompt_note?(d(),_("span",{key:0,class:"prompt-note-text",title:t.prompt_note},L(ie(t.prompt_note)),9,st)):(d(),_("span",nt,"点击编辑")),o(s,{class:"edit-icon"},{default:c(()=>[o(F(M))]),_:1})],8,ot)]),_:1})]),_:1},8,["data"])),[[me,P.value]])]),$.value>0?(d(),_("div",ct,[o(de,{"current-page":b.value,"onUpdate:currentPage":e[3]||(e[3]=t=>b.value=t),"page-size":z.value,"onUpdate:pageSize":e[4]||(e[4]=t=>z.value=t),"page-sizes":V,total:$.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:oe,onSizeChange:se},null,8,["current-page","page-size","total"])])):fe("",!0)]),_:1}),o(pe,{modelValue:j.value,"onUpdate:modelValue":e[6]||(e[6]=t=>j.value=t),title:"编辑提示词备注",width:"600px","close-on-click-modal":!1,onClose:G},{footer:c(()=>[m("div",dt,[o(i,{onClick:G},{default:c(()=>[...e[18]||(e[18]=[h("取消",-1)])]),_:1}),o(i,{type:"primary",loading:E.value,onClick:ce},{default:c(()=>[...e[19]||(e[19]=[h(" 保存 ",-1)])]),_:1},8,["loading"])])]),default:c(()=>[m("div",it,[o(v,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=t=>I.value=t),type:"textarea",rows:10,maxlength:rt,placeholder:"请输入提示词备注，最多2000字","show-word-limit":"",resize:"vertical"},null,8,["modelValue"]),m("div",ut,[o(_e,{type:"info",size:"small"},{default:c(()=>[...e[17]||(e[17]=[h(" 提示：提示词备注用于AI分析商品，需要分点描述，最多可输入2000个字符 ",-1)])]),_:1})])])]),_:1},8,["modelValue"])])}}}),yt=$e(_t,[["__scopeId","data-v-3b980351"]]);export{yt as default};
