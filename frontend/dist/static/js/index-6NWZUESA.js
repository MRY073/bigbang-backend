var $=(M,O,h)=>new Promise((N,V)=>{var m=f=>{try{S(h.next(f))}catch(T){V(T)}},F=f=>{try{S(h.throw(f))}catch(T){V(T)}},S=f=>f.done?N(f.value):Promise.resolve(f.value).then(m,F);S((h=h.apply(M,O)).next())});import{d as fe,M as ve,a as _,p as B,n as he,m as ye,k as g,e as p,f as i,w as c,g as u,i as Ce,h as x,F as W,l as X,b as Z,u as be,j as U,v as we,t as P,q as ee,fJ as w,fL as Se,_ as ke}from"./index-C6l8RhZe.js";import{g as xe}from"./products-C3rGUI67.js";import{g as Ve,u as Te}from"./productItems-DVrKzOBL.js";import{s as De,g as Fe,D as Ne}from"./shops-B4eWs2OP.js";const ze={class:"competitor-page"},Ie={class:"card-header"},$e={class:"left"},Ee={class:"actions"},Le={class:"filter-section"},Ue={class:"filter-inputs"},Pe={class:"filter-buttons"},Oe={class:"table-wrapper"},Be={class:"sort-icon"},Me={key:0},Ae={key:1},je={key:2},He={class:"cell-center"},Re={key:1,class:"dash"},qe={class:"cell-center"},Je=["onClick"],Ye={class:"cell-center"},Ge=["onClick"],Ke={class:"cell-center"},Qe=["src"],We={key:1,class:"no-img"},Xe={class:"save-actions"},Ze={class:"cell-center"},et={key:0},tt={key:1,class:"dash"},at={key:0,class:"pagination-wrapper"},lt=fe({name:"Competitor",__name:"index",setup(M){const O={testing:"测款阶段",potential:"潜力阶段",product:"成品阶段",abandoned:"放弃阶段"},h=ve([]),N=_(!1),V=_("all"),m=_(Ne),F=_(""),S=_(""),f=_(""),T=_(""),v=_(1),z=_(20),te=[10,20,50,100,200],y=_("default"),A=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],I=_([]),D=_("");function ae(l="加载中..."){return Se.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}function le(l){return l.map(e=>{var s,o,a,r,n;return typeof e=="string"?e:e&&typeof e=="object"&&(n=(r=(a=(o=(s=e.label)!=null?s:e.name)!=null?o:e.value)!=null?a:e.key)!=null?r:e.id)!=null?n:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean)}function j(l){if(!l.length)return;const e=new Set(I.value.map(o=>o.value));let s=!1;l.forEach(o=>{const a=o.trim();!a||e.has(a)||(I.value.push({label:a,value:a}),e.add(a),s=!0)}),s&&I.value.sort((o,a)=>o.label.localeCompare(a.label,"zh-Hans-CN"))}function oe(l){const e=[];return l.forEach(s=>{A.forEach(o=>{const a=s[o];if(typeof a=="string"){const r=a.trim();r&&e.push(r)}})}),e}function H(){return $(this,null,function*(){try{const l={};m.value&&(l.shopID=m.value);const e=yield Ve(l);if(e.success&&Array.isArray(e.data))j(le(e.data));else throw new Error(e.error||e.message||"获取自定义分类失败")}catch(l){console.error("获取自定义分类失败:",l)}})}function k(l){if(!l)return null;try{const e=new Date(l),s=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),d=String(e.getSeconds()).padStart(2,"0");return`${s}-${o}-${a} ${r}:${n}:${d}`}catch(e){return null}}function R(l){if(!l||l.trim()==="")return null;try{const e=new Date(l);return isNaN(e.getTime())?null:e.toISOString()}catch(e){return null}}function ne(l){const e=new Date,s=["abandoned","product","potential","testing"];for(const o of s){const a=l[`${o}_stage`];if(a!=null&&a.start_time&&(a!=null&&a.end_time))try{const r=R(a.start_time),n=R(a.end_time);if(r&&n){const d=new Date(r),C=new Date(n);if(!isNaN(d.getTime())&&!isNaN(C.getTime())&&d<=e&&e<=C)return o}}catch(r){}}return null}function se(l){h.value=l.map(e=>{var r,n,d,C,E,t,b,K;const s=A.map(L=>{var Q;return(Q=e[L])!=null?Q:""}).map(L=>typeof L=="string"?L.trim():"").filter(Boolean),o=s.join(" / "),a={product_id:e.product_id,product_name:e.product_name,product_image:e.product_image,testing_stage:{start_time:k(((r=e.testing_stage)==null?void 0:r.start_time)||null),end_time:k(((n=e.testing_stage)==null?void 0:n.end_time)||null)},potential_stage:{start_time:k(((d=e.potential_stage)==null?void 0:d.start_time)||null),end_time:k(((C=e.potential_stage)==null?void 0:C.end_time)||null)},product_stage:{start_time:k(((E=e.product_stage)==null?void 0:E.start_time)||null),end_time:k(((t=e.product_stage)==null?void 0:t.end_time)||null)},abandoned_stage:{start_time:k(((b=e.abandoned_stage)==null?void 0:b.start_time)||null),end_time:k(((K=e.abandoned_stage)==null?void 0:K.end_time)||null)},currentStage:null,customCategories:s,customCategoriesText:o,competitor_link:e.competitor_link||null,competitor_daily_sales:e.competitor_daily_sales||null,isSaving:!1};return a.currentStage=ne(a),a})}function re(){return $(this,null,function*(){if(!m.value){w.warning("请先选择店铺");return}N.value=!0;const l=ae("拉取数据中...");try{const e=Fe(m.value);if(!e)throw new Error("店铺信息不存在");const s={shopID:m.value,shopName:e.label};D.value&&(s.customCategory=D.value);const o=yield xe(s);if(o.success&&o.data)se(o.data),j(oe(o.data)),v.value=1,w.success(o.message||`数据拉取成功，共 ${h.value.length} 条`);else throw console.error("数据验证失败:",{success:o.success,hasData:!!o.data,error:o.error,message:o.message}),new Error(o.error||o.message||"查询失败")}catch(e){console.error("拉取数据失败:",e),w.error((e==null?void 0:e.message)||"网络连接失败，请检查网络后重试"),h.value=[]}finally{l.close(),N.value=!1}})}function ie(l){return $(this,null,function*(){var s,o;if(!m.value){w.warning("请先选择店铺");return}const e=h.value.find(a=>a.product_id===l);if(!e){w.error("商品不存在");return}e.isSaving=!0;try{const a=((s=e.competitor_link)==null?void 0:s.trim())||null,r=((o=e.competitor_daily_sales)==null?void 0:o.trim())||null,n=yield Te(l,{competitor_link:a===""?null:a,competitor_daily_sales:r===""?null:r});if(n.success)w.success(n.message||"保存成功");else throw new Error(n.error||n.message||"更新失败")}catch(a){console.error("保存竞争对手信息失败:",a),w.error((a==null?void 0:a.message)||"保存失败，请检查网络后重试")}finally{e.isSaving=!1}})}const q=B(()=>{const l=h.value;if(l.length===0)return[];let e;if(V.value==="all")e=l;else{const a=V.value;e=l.filter(r=>{const n=r[`${a}_stage`],d=(n==null?void 0:n.start_time)&&(n==null?void 0:n.end_time),C=r.currentStage===a;return d||C})}if(D.value){const a=D.value.trim();e=e.filter(r=>r.customCategories.some(n=>n.trim()===a))}const s=f.value.trim();if(s){const a=s.toLowerCase();e=e.filter(r=>r.product_id.toLowerCase().includes(a))}const o=T.value.trim();if(o){const a=o.toLowerCase();e=e.filter(r=>r.product_name.toLowerCase().includes(a))}return y.value!=="default"&&(e=e.slice().sort((a,r)=>{const n=a.currentStage||"",d=r.currentStage||"";return!n&&!d?0:n?d?y.value==="asc"?n.localeCompare(d):d.localeCompare(n):-1:1})),e}),ce=B(()=>{const l=q.value,e=(v.value-1)*z.value,s=e+z.value;return l.slice(e,s)}),J=B(()=>q.value.length);function ue(l){v.value=l}function de(l){z.value=l,v.value=1}function Y(l){return $(this,null,function*(){try{if(navigator.clipboard&&navigator.clipboard.writeText)yield navigator.clipboard.writeText(l);else{const e=document.createElement("textarea");e.value=l,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}w.success("已复制到剪贴板")}catch(e){w.error("复制失败")}})}function pe(){f.value=F.value,T.value=S.value,v.value=1}function me(){F.value="",S.value="",f.value="",T.value="",v.value=1}function ge(){y.value==="default"?y.value="asc":y.value==="asc"?y.value="desc":y.value="default",v.value=1}function _e(){v.value=1}function G(){I.value=[],D.value="",m.value&&H(),v.value=1}return he(m,()=>{G()}),ye(()=>{m.value&&H()}),(l,e)=>{const s=x("el-option"),o=x("el-select"),a=x("el-button"),r=x("el-input"),n=x("el-table-column"),d=x("el-table"),C=x("el-pagination"),E=x("el-card");return p(),g("div",ze,[i(E,{class:"competitor-card"},{default:c(()=>[u("div",Ie,[u("div",$e,[i(o,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=t=>V.value=t),placeholder:"筛选阶段",style:{width:"220px"}},{default:c(()=>[i(s,{label:"全部",value:"all"}),i(s,{label:"测款阶段",value:"testing"}),i(s,{label:"潜力阶段",value:"potential"}),i(s,{label:"成品阶段",value:"product"}),i(s,{label:"放弃阶段",value:"abandoned"})]),_:1},8,["modelValue"]),i(o,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),placeholder:"自定义分类",clearable:"",filterable:"",style:{width:"220px"},onChange:_e},{default:c(()=>[(p(!0),g(W,null,X(I.value,t=>(p(),Z(s,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u("div",Ee,[i(o,{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=t=>m.value=t),placeholder:"选择店铺",style:{width:"200px","margin-right":"12px"},onChange:G},{default:c(()=>[(p(!0),g(W,null,X(be(De),t=>(p(),Z(s,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(a,{type:"primary",loading:N.value,icon:"el-icon-refresh",onClick:re},{default:c(()=>[...e[7]||(e[7]=[U("拉取数据",-1)])]),_:1},8,["loading"])])]),u("div",Le,[u("div",Ue,[i(r,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=t=>F.value=t),placeholder:"产品ID",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"]),i(r,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),placeholder:"产品名称",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"])]),u("div",Pe,[i(a,{type:"primary",onClick:pe},{default:c(()=>[...e[8]||(e[8]=[U("筛选",-1)])]),_:1}),i(a,{onClick:me},{default:c(()=>[...e[9]||(e[9]=[U("取消筛选",-1)])]),_:1})])]),u("div",Oe,[i(d,{data:ce.value,stripe:"",style:{width:"100%"},"row-key":t=>t.product_id,"row-class-name":({row:t})=>t.currentStage==="abandoned"?"row-abandoned":"","max-height":600},{default:c(()=>[i(n,{prop:"currentStage",label:"当前阶段",width:"140",align:"center","header-align":"center",fixed:"left"},{header:c(()=>[u("div",{class:"sortable-header",onClick:ge},[e[10]||(e[10]=u("span",null,"当前阶段",-1)),u("span",Be,[y.value==="default"?(p(),g("span",Me,"⇅")):y.value==="asc"?(p(),g("span",Ae,"↑")):(p(),g("span",je,"↓"))])])]),default:c(({row:t})=>[u("div",He,[t.currentStage?(p(),g("span",{key:0,class:we(`current-badge stage-${t.currentStage}`)},P(O[t.currentStage]||t.currentStage),3)):(p(),g("span",Re,"-"))])]),_:1}),i(n,{prop:"product_id",label:"产品ID",width:"160",align:"center","header-align":"center",fixed:"left"},{default:c(({row:t})=>[u("div",qe,[u("span",{class:"plain-text",title:"点击复制",onClick:ee(b=>Y(t.product_id),["stop"])},P(t.product_id),9,Je)])]),_:1}),i(n,{prop:"product_name",label:"产品名称",width:"300",align:"center","header-align":"center",fixed:"left"},{default:c(({row:t})=>[u("div",Ye,[u("span",{class:"plain-text",title:"点击复制",onClick:ee(b=>Y(t.product_name),["stop"])},P(t.product_name),9,Ge)])]),_:1}),i(n,{prop:"product_image",label:"产品主图",width:"120",align:"center","header-align":"center",fixed:"left"},{default:c(({row:t})=>[u("div",Ke,[t.product_image?(p(),g("img",{key:0,src:t.product_image,alt:"主图",class:"thumb"},null,8,Qe)):(p(),g("div",We,"无图"))])]),_:1}),i(n,{label:"操作",width:"120",align:"center","header-align":"center",fixed:"left"},{default:c(({row:t})=>[u("div",Xe,[i(a,{type:"primary",size:"small",loading:t.isSaving,onClick:b=>ie(t.product_id)},{default:c(()=>[...e[11]||(e[11]=[U("保存",-1)])]),_:1},8,["loading","onClick"])])]),_:1}),i(n,{label:"竞争对手链接","min-width":"300",align:"center","header-align":"center"},{default:c(({row:t})=>[i(r,{modelValue:t.competitor_link,"onUpdate:modelValue":b=>t.competitor_link=b,type:"textarea",rows:2,placeholder:"请输入竞争对手链接",clearable:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(n,{label:"竞争对手日销",width:"200",align:"center","header-align":"center"},{default:c(({row:t})=>[i(r,{modelValue:t.competitor_daily_sales,"onUpdate:modelValue":b=>t.competitor_daily_sales=b,placeholder:"请输入竞争对手日销",clearable:""},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(n,{label:"自定义分类","min-width":"220",align:"center","header-align":"center"},{default:c(({row:t})=>[u("div",Ze,[t.customCategoriesText&&t.customCategoriesText.length?(p(),g("span",et,P(t.customCategoriesText),1)):(p(),g("span",tt,"-"))])]),_:1})]),_:1},8,["data","row-key","row-class-name"])]),J.value>0?(p(),g("div",at,[i(C,{"current-page":v.value,"onUpdate:currentPage":e[5]||(e[5]=t=>v.value=t),"page-size":z.value,"onUpdate:pageSize":e[6]||(e[6]=t=>z.value=t),"page-sizes":te,total:J.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:ue,onSizeChange:de},null,8,["current-page","page-size","total"])])):Ce("",!0)]),_:1})])}}}),ct=ke(lt,[["__scopeId","data-v-8c74fbc6"]]);export{ct as default};
