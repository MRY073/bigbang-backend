var F=(j,U,b)=>new Promise(($,M)=>{var g=h=>{try{V(b.next(h))}catch(k){M(k)}},T=h=>{try{V(b.throw(h))}catch(k){M(k)}},V=h=>h.done?$(h.value):Promise.resolve(h.value).then(g,T);V((b=b.apply(j,U)).next())});import{d as ye,M as be,a as v,p as B,n as Ye,m as Ce,k as f,e as _,f as i,w as m,g as c,i as De,h as D,F as Z,l as ee,b as Ve,j as I,v as we,t as L,q as te,fL as Y,fM as Se,_ as xe}from"./index-DK89ZJMH.js";import{g as Me,u as ke}from"./products-4xSqN2Ai.js";import{a as He}from"./productItems-DoU_wn2M.js";const Te={class:"product-stage-page"},Fe={class:"card-header"},Ue={class:"left"},$e={class:"actions"},Ne={class:"filter-section"},Ee={class:"filter-inputs"},Pe={class:"filter-buttons"},ze={class:"table-wrapper"},Ie={class:"sort-icon"},Le={key:0},Oe={key:1},Be={key:2},je={class:"cell-center"},Ae={key:1,class:"dash"},qe={class:"cell-center"},Re=["onClick"],Ge={class:"cell-center"},Je=["onClick"],Ke={class:"cell-center"},Qe=["src"],We={key:1,class:"no-img"},Xe={class:"save-actions"},Ze={class:"stage-editor"},et={class:"time-picker-group"},tt={class:"stage-editor"},at={class:"time-picker-group"},lt={class:"stage-editor"},nt={class:"time-picker-group"},st={class:"stage-editor"},ot={class:"time-picker-group"},rt={class:"cell-center"},it={key:0},dt={key:1,class:"dash"},ct={key:0,class:"pagination-wrapper"},ut=ye({name:"ProductStageManual",__name:"index",setup(j){const U={testing:"测款阶段",potential:"潜力阶段",product:"成品阶段",abandoned:"放弃阶段"},b=be([]),$=v(!1),M=v("all"),g=v("1489850435"),T=v(""),V=v(""),h=v(""),k=v(""),y=v(1),N=v(20),ae=[10,20,50,100,200],C=v("default"),O=[{label:"Modern Nest|泰国",value:"1489850435"},{label:"shop07|泰国",value:"1638595255"}],A=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],E=v([]),H=v("");function le(l="加载中..."){return Se.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}function ne(l){return l.map(e=>{var o,n,a,r,s;return typeof e=="string"?e:e&&typeof e=="object"&&(s=(r=(a=(n=(o=e.label)!=null?o:e.name)!=null?n:e.value)!=null?a:e.key)!=null?r:e.id)!=null?s:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean)}function q(l){if(!l.length)return;const e=new Set(E.value.map(n=>n.value));let o=!1;l.forEach(n=>{const a=n.trim();!a||e.has(a)||(E.value.push({label:a,value:a}),e.add(a),o=!0)}),o&&E.value.sort((n,a)=>n.label.localeCompare(a.label,"zh-Hans-CN"))}function se(l){const e=[];return l.forEach(o=>{A.forEach(n=>{const a=o[n];if(typeof a=="string"){const r=a.trim();r&&e.push(r)}})}),e}function R(){return F(this,null,function*(){try{const l={};g.value&&(l.shopID=g.value);const e=yield He(l);if(e.success&&Array.isArray(e.data))q(ne(e.data));else throw new Error(e.error||e.message||"获取自定义分类失败")}catch(l){console.error("获取自定义分类失败:",l)}})}function w(l){if(!l)return null;try{const e=new Date(l),o=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0"),d=String(e.getSeconds()).padStart(2,"0");return`${o}-${n}-${a} ${r}:${s}:${d}`}catch(e){return null}}function S(l){if(!l||l.trim()==="")return null;try{const e=new Date(l);return isNaN(e.getTime())?null:e.toISOString()}catch(e){return null}}function oe(l,e){if(!l.start_time||!l.end_time||!e.start_time||!e.end_time)return!1;try{const o=S(l.start_time),n=S(l.end_time),a=S(e.start_time),r=S(e.end_time);if(!o||!n||!a||!r)return!1;const s=new Date(o),d=new Date(n),p=new Date(a),x=new Date(r);return s>=p&&s<=x||d>=p&&d<=x||s<=p&&d>=x}catch(o){return!1}}function re(l){const e=["testing","potential","product","abandoned"],o=[];for(let n=0;n<e.length;n++)for(let a=n+1;a<e.length;a++){const r=e[n],s=e[a],d=l[`${r}_stage`],p=l[`${s}_stage`];oe(d,p)&&o.push([r,s])}return o}function G(l){const e=new Date,o=["abandoned","product","potential","testing"];for(const n of o){const a=l[`${n}_stage`];if(a!=null&&a.start_time&&(a!=null&&a.end_time))try{const r=S(a.start_time),s=S(a.end_time);if(r&&s){const d=new Date(r),p=new Date(s);if(!isNaN(d.getTime())&&!isNaN(p.getTime())&&d<=e&&e<=p)return n}}catch(r){}}return null}function ie(l){b.value=l.map(e=>{var r,s,d,p,x,P,t,u;const o=A.map(z=>{var X;return(X=e[z])!=null?X:""}).map(z=>typeof z=="string"?z.trim():"").filter(Boolean),n=o.join(" / "),a={product_id:e.product_id,product_name:e.product_name,product_image:e.product_image,testing_stage:{start_time:w(((r=e.testing_stage)==null?void 0:r.start_time)||null),end_time:w(((s=e.testing_stage)==null?void 0:s.end_time)||null)},potential_stage:{start_time:w(((d=e.potential_stage)==null?void 0:d.start_time)||null),end_time:w(((p=e.potential_stage)==null?void 0:p.end_time)||null)},product_stage:{start_time:w(((x=e.product_stage)==null?void 0:x.start_time)||null),end_time:w(((P=e.product_stage)==null?void 0:P.end_time)||null)},abandoned_stage:{start_time:w(((t=e.abandoned_stage)==null?void 0:t.start_time)||null),end_time:w(((u=e.abandoned_stage)==null?void 0:u.end_time)||null)},savingFlags:{testing:!1,potential:!1,product:!1,abandoned:!1},currentStage:null,customCategories:o,customCategoriesText:n};return a.currentStage=G(a),a})}function de(){return F(this,null,function*(){if(!g.value){Y.warning("请先选择店铺");return}$.value=!0;const l=le("拉取数据中...");try{const e=O.find(a=>a.value===g.value);if(!e)throw new Error("店铺信息不存在");const o={shopID:g.value,shopName:e.label};H.value&&(o.customCategory=H.value);const n=yield Me(o);if(n.success&&n.data)ie(n.data),q(se(n.data)),y.value=1,Y.success(n.message||`数据拉取成功，共 ${b.value.length} 条`);else throw console.error("数据验证失败:",{success:n.success,hasData:!!n.data,error:n.error,message:n.message}),new Error(n.error||n.message||"查询失败")}catch(e){console.error("拉取数据失败:",e),Y.error((e==null?void 0:e.message)||"网络连接失败，请检查网络后重试"),b.value=[]}finally{l.close(),$.value=!1}})}function ce(l,e,o,n){return F(this,null,function*(){const a=O.find(p=>p.value===g.value);if(!a)throw new Error("店铺信息不存在");const r=S(o),s=S(n),d=yield ke({product_id:l,shopID:g.value,shopName:a.label,stage_type:e,start_time:r,end_time:s});if(!d.success)throw new Error(d.error||d.message||"更新失败")})}function ue(l){return F(this,null,function*(){if(!g.value){Y.warning("请先选择店铺");return}const e=b.value.find(a=>a.product_id===l);if(!e){Y.error("商品不存在");return}const o=re(e);if(o.length>0){const a=o.map(([r,s])=>`${U[r]}和${U[s]}`).join("、");Y.error(`时间段重叠：${a}的时间段存在重叠，请检查后重试`);return}const n=["testing","potential","product","abandoned"];n.forEach(a=>{e.savingFlags[a]=!0});try{const a=n.map(r=>{const s=e[`${r}_stage`];return ce(l,r,s.start_time,s.end_time)});yield Promise.all(a),e.currentStage=G(e),Y.success("保存成功")}catch(a){console.error("保存阶段失败:",a),Y.error((a==null?void 0:a.message)||"保存失败，请检查网络后重试")}finally{n.forEach(a=>{e.savingFlags[a]=!1})}})}const J=B(()=>{const l=b.value;if(l.length===0)return[];let e;if(M.value==="all")e=l;else{const a=M.value;e=l.filter(r=>{const s=r[`${a}_stage`],d=(s==null?void 0:s.start_time)&&(s==null?void 0:s.end_time),p=r.currentStage===a;return d||p})}if(H.value){const a=H.value.trim();e=e.filter(r=>r.customCategories.some(s=>s.trim()===a))}const o=h.value.trim();if(o){const a=o.toLowerCase();e=e.filter(r=>r.product_id.toLowerCase().includes(a))}const n=k.value.trim();if(n){const a=n.toLowerCase();e=e.filter(r=>r.product_name.toLowerCase().includes(a))}return C.value!=="default"&&(e=e.slice().sort((a,r)=>{const s=a.currentStage||"",d=r.currentStage||"";return!s&&!d?0:s?d?C.value==="asc"?s.localeCompare(d):d.localeCompare(s):-1:1})),e}),me=B(()=>{const l=J.value,e=(y.value-1)*N.value,o=e+N.value;return l.slice(e,o)}),K=B(()=>J.value.length);function pe(l){y.value=l}function ge(l){N.value=l,y.value=1}function Q(l){return F(this,null,function*(){try{if(navigator.clipboard&&navigator.clipboard.writeText)yield navigator.clipboard.writeText(l);else{const e=document.createElement("textarea");e.value=l,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}Y.success("已复制到剪贴板")}catch(e){Y.error("复制失败")}})}function _e(){h.value=T.value,k.value=V.value,y.value=1}function fe(){T.value="",V.value="",h.value="",k.value="",y.value=1}function ve(){C.value==="default"?C.value="asc":C.value==="asc"?C.value="desc":C.value="default",y.value=1}function he(){y.value=1}function W(){E.value=[],H.value="",g.value&&R(),y.value=1}return Ye(g,()=>{W()}),Ce(()=>{g.value&&R()}),(l,e)=>{const o=D("el-option"),n=D("el-select"),a=D("el-button"),r=D("el-input"),s=D("el-table-column"),d=D("el-date-picker"),p=D("el-table"),x=D("el-pagination"),P=D("el-card");return _(),f("div",Te,[i(P,{class:"stage-card"},{default:m(()=>[c("div",Fe,[c("div",Ue,[i(n,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=t=>M.value=t),placeholder:"筛选阶段",style:{width:"220px"}},{default:m(()=>[i(o,{label:"全部",value:"all"}),i(o,{label:"测款阶段",value:"testing"}),i(o,{label:"潜力阶段",value:"potential"}),i(o,{label:"成品阶段",value:"product"}),i(o,{label:"放弃阶段",value:"abandoned"})]),_:1},8,["modelValue"]),i(n,{modelValue:H.value,"onUpdate:modelValue":e[1]||(e[1]=t=>H.value=t),placeholder:"自定义分类",clearable:"",filterable:"",style:{width:"220px"},onChange:he},{default:m(()=>[(_(!0),f(Z,null,ee(E.value,t=>(_(),Ve(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),c("div",$e,[i(n,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=t=>g.value=t),placeholder:"选择店铺",style:{width:"200px","margin-right":"12px"},onChange:W},{default:m(()=>[(_(),f(Z,null,ee(O,t=>i(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),i(a,{type:"primary",loading:$.value,icon:"el-icon-refresh",onClick:de},{default:m(()=>[...e[7]||(e[7]=[I("拉取数据",-1)])]),_:1},8,["loading"])])]),c("div",Ne,[c("div",Ee,[i(r,{modelValue:T.value,"onUpdate:modelValue":e[3]||(e[3]=t=>T.value=t),placeholder:"产品ID",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"]),i(r,{modelValue:V.value,"onUpdate:modelValue":e[4]||(e[4]=t=>V.value=t),placeholder:"产品名称",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"])]),c("div",Pe,[i(a,{type:"primary",onClick:_e},{default:m(()=>[...e[8]||(e[8]=[I("筛选",-1)])]),_:1}),i(a,{onClick:fe},{default:m(()=>[...e[9]||(e[9]=[I("取消筛选",-1)])]),_:1})])]),c("div",ze,[i(p,{data:me.value,stripe:"",style:{width:"100%"},"row-key":t=>t.product_id,"row-class-name":({row:t})=>t.currentStage==="abandoned"?"row-abandoned":"","max-height":600},{default:m(()=>[i(s,{prop:"currentStage",label:"当前阶段",width:"140",align:"center","header-align":"center",fixed:"left"},{header:m(()=>[c("div",{class:"sortable-header",onClick:ve},[e[10]||(e[10]=c("span",null,"当前阶段",-1)),c("span",Ie,[C.value==="default"?(_(),f("span",Le,"⇅")):C.value==="asc"?(_(),f("span",Oe,"↑")):(_(),f("span",Be,"↓"))])])]),default:m(({row:t})=>[c("div",je,[t.currentStage?(_(),f("span",{key:0,class:we(`current-badge stage-${t.currentStage}`)},L(U[t.currentStage]||t.currentStage),3)):(_(),f("span",Ae,"-"))])]),_:1}),i(s,{prop:"product_id",label:"产品ID",width:"160",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",qe,[c("span",{class:"plain-text",title:"点击复制",onClick:te(u=>Q(t.product_id),["stop"])},L(t.product_id),9,Re)])]),_:1}),i(s,{prop:"product_name",label:"产品名称",width:"300",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",Ge,[c("span",{class:"plain-text",title:"点击复制",onClick:te(u=>Q(t.product_name),["stop"])},L(t.product_name),9,Je)])]),_:1}),i(s,{prop:"product_image",label:"产品主图",width:"120",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",Ke,[t.product_image?(_(),f("img",{key:0,src:t.product_image,alt:"主图",class:"thumb"},null,8,Qe)):(_(),f("div",We,"无图"))])]),_:1}),i(s,{label:"操作",width:"120",align:"center","header-align":"center",fixed:"left"},{default:m(({row:t})=>[c("div",Xe,[i(a,{type:"primary",size:"small",loading:t.savingFlags.testing||t.savingFlags.potential||t.savingFlags.product||t.savingFlags.abandoned,onClick:u=>ue(t.product_id)},{default:m(()=>[...e[11]||(e[11]=[I("保存",-1)])]),_:1},8,["loading","onClick"])])]),_:1}),i(s,{label:"测款阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",Ze,[c("div",et,[i(d,{modelValue:t.testing_stage.start_time,"onUpdate:modelValue":u=>t.testing_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.testing_stage.end_time,"onUpdate:modelValue":u=>t.testing_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(s,{label:"潜力阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",tt,[c("div",at,[i(d,{modelValue:t.potential_stage.start_time,"onUpdate:modelValue":u=>t.potential_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.potential_stage.end_time,"onUpdate:modelValue":u=>t.potential_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(s,{label:"成品阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",lt,[c("div",nt,[i(d,{modelValue:t.product_stage.start_time,"onUpdate:modelValue":u=>t.product_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.product_stage.end_time,"onUpdate:modelValue":u=>t.product_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(s,{label:"放弃阶段",width:"280",align:"center","header-align":"center"},{default:m(({row:t})=>[c("div",st,[c("div",ot,[i(d,{modelValue:t.abandoned_stage.start_time,"onUpdate:modelValue":u=>t.abandoned_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:t.abandoned_stage.end_time,"onUpdate:modelValue":u=>t.abandoned_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(s,{label:"自定义分类","min-width":"220",align:"center","header-align":"center",fixed:"right"},{default:m(({row:t})=>[c("div",rt,[t.customCategoriesText&&t.customCategoriesText.length?(_(),f("span",it,L(t.customCategoriesText),1)):(_(),f("span",dt,"-"))])]),_:1})]),_:1},8,["data","row-key","row-class-name"])]),K.value>0?(_(),f("div",ct,[i(x,{"current-page":y.value,"onUpdate:currentPage":e[5]||(e[5]=t=>y.value=t),"page-size":N.value,"onUpdate:pageSize":e[6]||(e[6]=t=>N.value=t),"page-sizes":ae,total:K.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:pe,onSizeChange:ge},null,8,["current-page","page-size","total"])])):De("",!0)]),_:1})])}}}),ft=xe(ut,[["__scopeId","data-v-7b9705a6"]]);export{ft as default};
