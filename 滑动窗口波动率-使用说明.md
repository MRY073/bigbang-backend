# 滑动窗口波动率计算模块

## 📋 功能说明

新增了 `calculateSlidingVolatility()` 函数，用于计算滑动窗口波动率指标。该函数与现有的变化指数（Change Index）逻辑并行存在，不会覆盖或删除旧代码。

## 🔧 函数接口

```typescript
/**
 * 计算滑动窗口波动率
 * @param values 按日期排序的数值数组（从早到晚）
 * @returns 每个滑动窗口的波动率信息数组
 */
private calculateSlidingVolatility(values: number[]): Array<{
  window: number;                    // 滑动窗口天数
  direction: '+' | '-';              // 窗口内平均变化方向
  strength: number;                  // 变化强度，0~100
  level: '极小' | '轻微' | '一般' | '明显' | '剧烈';  // 根据强度划分等级
}>
```

## 📊 计算逻辑

### 1. 滑动窗口
支持以下窗口大小：**1天、3天、7天、15天、30天**

### 2. 每日增幅计算
对窗口内的数据，计算每日增幅：
```
r_t = (今天值 - 昨天值) / 昨天值
```

### 3. 方向判断
- 计算窗口内所有每日增幅的平均值：`meanRate = 平均(所有r_t)`
- 如果 `meanRate >= 0`，方向为 `+`（上升）
- 如果 `meanRate < 0`，方向为 `-`（下降）

### 4. 波动强度计算
使用**平均绝对偏差（MAD）**方法：
```
MAD = mean(|r_t - meanRate|)
strength = min(MAD * 200, 100)
```

**说明：**
- MAD 表示窗口内每日增幅相对于平均值的平均偏离程度
- 假设 MAD 在 0~0.5 之间（即50%的变化），映射到 0~100
- 最终强度限制在 0~100 范围内

### 5. 强度等级划分
根据 `strength` 值划分等级：
- **0 ~ 10**：极小（基本稳定，几乎无波动）
- **10 ~ 30**：轻微（轻微波动，不影响判断）
- **30 ~ 60**：一般（中等波动，值得关注）
- **60 ~ 80**：明显（波动较大，需要关注趋势）
- **80 ~ 100**：剧烈（波动非常大，风险高或异常明显）

## 💡 使用示例

```typescript
// 示例数据：7天的销售额
const salesData = [100, 120, 110, 130, 105, 140, 125];

// 调用函数
const volatility = calculateSlidingVolatility(salesData);

// 输出结果示例：
[
  {
    window: 1,
    direction: '-',
    strength: 0,
    level: '极小'
  },
  {
    window: 3,
    direction: '+',
    strength: 15.25,
    level: '轻微'
  },
  {
    window: 7,
    direction: '+',
    strength: 28.50,
    level: '轻微'
  },
  {
    window: 15,
    direction: '+',
    strength: 28.50,  // 数据不足15天，使用所有可用数据
    level: '轻微'
  },
  {
    window: 30,
    direction: '+',
    strength: 28.50,  // 数据不足30天，使用所有可用数据
    level: '轻微'
  }
]
```

## 🔍 计算示例详解

假设有7天的销售额数据：`[100, 120, 110, 130, 105, 140, 125]`

### 步骤1：计算每日增幅
- Day1→Day2: (120-100)/100 = 0.20 (20%)
- Day2→Day3: (110-120)/120 = -0.083 (-8.3%)
- Day3→Day4: (130-110)/110 = 0.182 (18.2%)
- Day4→Day5: (105-130)/130 = -0.192 (-19.2%)
- Day5→Day6: (140-105)/105 = 0.333 (33.3%)
- Day6→Day7: (125-140)/140 = -0.107 (-10.7%)

每日增幅数组：`[0.20, -0.083, 0.182, -0.192, 0.333, -0.107]`

### 步骤2：计算3天窗口的波动率
取最后3天的增幅：`[-0.192, 0.333, -0.107]`

1. **平均每日增幅**：meanRate = (-0.192 + 0.333 - 0.107) / 3 = 0.0113
   - 方向：`+`（上升）

2. **平均绝对偏差**：
   - |(-0.192) - 0.0113| = 0.2033
   - |0.333 - 0.0113| = 0.3217
   - |(-0.107) - 0.0113| = 0.1183
   - MAD = (0.2033 + 0.3217 + 0.1183) / 3 = 0.2144

3. **波动强度**：strength = min(0.2144 * 200, 100) = 42.88

4. **等级**：42.88 在 30-60 之间，等级为 `一般`

结果：`{ window: 3, direction: '+', strength: 42.88, level: '一般' }`

## ⚠️ 边界情况处理

1. **数据不足2个**：所有窗口返回默认值（direction: '+', strength: 0, level: '极小'）

2. **窗口大于数据量**：使用所有可用数据计算

3. **窗口内只有1个数据点**：波动强度为0，等级为'极小'

4. **无效值过滤**：自动过滤掉0或负数值（视为无数据）

## 🔄 与变化指数的区别

| 特性 | 变化指数（Change Index） | 滑动窗口波动率（Sliding Volatility） |
|------|------------------------|-----------------------------------|
| 计算范围 | 整个时间段 | 滑动窗口（1/3/7/15/30天） |
| 方向判断 | 平均每日增幅 | 窗口内平均每日增幅 |
| 强度计算 | 最大振幅（max-min） | 平均绝对偏差（MAD） |
| 输出格式 | 单个值 | 5个窗口的数组 |
| 适用场景 | 整体波动评估 | 不同时间尺度的波动分析 |

## 📝 注意事项

1. 函数是 `private` 方法，需要在 `ProductsService` 类内部调用
2. 输入数组必须按日期从早到晚排序
3. 函数会自动过滤无效值（≤0）
4. 强度值保留2位小数
5. 所有窗口的计算基于相同的每日增幅数据，只是窗口大小不同

