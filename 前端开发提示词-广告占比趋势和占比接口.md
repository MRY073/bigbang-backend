# 前端开发提示词：广告占比趋势和占比接口

## 概述

本文档提供两个广告占比相关接口的前端调用说明，用于适配已实现的页面布局。页面布局已存在，只需要实现接口调用和数据适配。

## 接口说明

### 接口1：30天广告占比趋势

**接口地址**: `GET /products/ad-trend`

**请求参数**:
- `shop` (query参数, 必需): 商店ID（店铺名称），字符串类型

**请求示例**:
```
GET /products/ad-trend?shop=店铺名称
```

**响应格式**:
```json
{
  "success": true,
  "message": "查询成功",
  "data": [
    {
      "date": "2025-01-01",
      "testing_stage_spend": 100.50,
      "potential_stage_spend": 200.30,
      "product_stage_spend": 500.80,
      "abandoned_stage_spend": 50.20,
      "no_stage_spend": 0
    },
    {
      "date": "2025-01-02",
      "testing_stage_spend": 120.00,
      "potential_stage_spend": 180.50,
      "product_stage_spend": 550.20,
      "abandoned_stage_spend": 30.00,
      "no_stage_spend": 0
    }
    // ... 共30天的数据，按日期升序排列
  ]
}
```

**数据结构说明**:
- `date`: 日期字符串，格式为 `YYYY-MM-DD`
- `testing_stage_spend`: 测款阶段花费（数字，可能为小数）
- `potential_stage_spend`: 潜力阶段花费（数字，可能为小数）
- `product_stage_spend`: 成品阶段花费（数字，可能为小数）
- `abandoned_stage_spend`: 放弃阶段花费（数字，可能为小数）
- `no_stage_spend`: 无阶段花费（数字，可能为小数）

**注意事项**:
- 返回数据固定为30天（包含今天）
- 如果某天没有数据，所有阶段的花费都为 0
- 所有数值都是实际花费金额，不是百分比

### 接口2：指定日期广告占比

**接口地址**: `GET /products/ad-ratio`

**请求参数**:
- `shop` (query参数, 必需): 商店ID（店铺名称），字符串类型
- `date` (query参数, 必需): 日期，格式为 `YYYY-MM-DD`，字符串类型

**请求示例**:
```
GET /products/ad-ratio?shop=店铺名称&date=2025-01-15
```

**响应格式**:
```json
{
  "success": true,
  "message": "查询成功",
  "data": {
    "date": "2025-01-15",
    "stages": {
      "testing_stage": {
        "spend": 100.50
      },
      "potential_stage": {
        "spend": 200.30
      },
      "product_stage": {
        "spend": 500.80,
        "sales_amount": 1500.00,
        "roi": 2.99
      },
      "abandoned_stage": {
        "spend": 50.20
      },
      "no_stage": {
        "spend": 0
      }
    }
  }
}
```

**数据结构说明**:
- `date`: 日期字符串，格式为 `YYYY-MM-DD`
- `stages`: 各阶段数据对象
  - `testing_stage`: 测款阶段对象
    - `spend`: 花费（数字）
  - `potential_stage`: 潜力阶段对象
    - `spend`: 花费（数字）
  - `product_stage`: 成品阶段对象（**重要：只有成品阶段有产出和ROI数据**）
    - `spend`: 花费（数字）
    - `sales_amount`: 产出/销售额（数字）
    - `roi`: ROI（广告支出回报率，数字，可能为小数）
  - `abandoned_stage`: 放弃阶段对象
    - `spend`: 花费（数字）
  - `no_stage`: 无阶段对象
    - `spend`: 花费（数字）

**注意事项**:
- **只有成品阶段（product_stage）有 `sales_amount` 和 `roi` 字段**
- 其他阶段只有 `spend` 字段
- 如果某个阶段没有数据，花费为 0
- ROI 是加权平均计算的结果

## 前端实现要求

### 1. API 调用函数封装

**推荐在 `api.ts` 或 `services.ts` 文件中封装接口调用函数**:

```typescript
// api.ts 或 services/adApi.ts

/**
 * 30天广告占比趋势接口
 * @param shop 商店ID（店铺名称）
 * @returns 30天的趋势数据
 */
export async function getAdTrend30Days(shop: string): Promise<
  Array<{
    date: string;
    testing_stage_spend: number;
    potential_stage_spend: number;
    product_stage_spend: number;
    abandoned_stage_spend: number;
    no_stage_spend: number;
  }>
> {
  const response = await fetch(
    `/products/ad-trend?shop=${encodeURIComponent(shop)}`
  );
  const result = await response.json();

  if (!result.success) {
    throw new Error(result.error || result.message || '查询失败');
  }

  return result.data || [];
}

/**
 * 指定日期广告占比接口
 * @param shop 商店ID（店铺名称）
 * @param date 日期（YYYY-MM-DD 格式）
 * @returns 指定日期的广告占比数据
 */
export async function getAdRatioByDate(
  shop: string,
  date: string
): Promise<{
  date: string;
  stages: {
    testing_stage: { spend: number };
    potential_stage: { spend: number };
    product_stage: {
      spend: number;
      sales_amount: number;
      roi: number;
    };
    abandoned_stage: { spend: number };
    no_stage: { spend: number };
  };
}> {
  const response = await fetch(
    `/products/ad-ratio?shop=${encodeURIComponent(shop)}&date=${encodeURIComponent(date)}`
  );
  const result = await response.json();

  if (!result.success) {
    throw new Error(result.error || result.message || '查询失败');
  }

  return result.data;
}
```

### 2. 在组件中调用接口

**30天广告占比趋势接口调用示例**:

```typescript
import { useState, useEffect } from 'react';
import { getAdTrend30Days } from '@/api'; // 根据实际路径调整

const AdTrendPage = () => {
  const [shop, setShop] = useState<string>(''); // 从页面选择器获取
  const [loading, setLoading] = useState<boolean>(false);
  const [trendData, setTrendData] = useState<
    Array<{
      date: string;
      testing_stage_spend: number;
      potential_stage_spend: number;
      product_stage_spend: number;
      abandoned_stage_spend: number;
      no_stage_spend: number;
    }>
  >([]);
  const [error, setError] = useState<string | null>(null);

  // 查询30天趋势数据
  const fetchTrendData = async () => {
    if (!shop) {
      setError('请选择店铺');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const data = await getAdTrend30Days(shop);
      setTrendData(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : '查询失败');
      setTrendData([]);
    } finally {
      setLoading(false);
    }
  };

  // 当店铺变化时自动查询（或手动触发）
  useEffect(() => {
    if (shop) {
      fetchTrendData();
    }
  }, [shop]); // 根据实际需求调整触发时机

  // 数据适配：将接口数据转换为图表所需格式
  // 例如，如果使用 ECharts 或其他图表库
  const chartData = trendData.map((item) => ({
    date: item.date,
    categories: [
      { name: '测款阶段', value: item.testing_stage_spend },
      { name: '潜力阶段', value: item.potential_stage_spend },
      { name: '成品阶段', value: item.product_stage_spend },
      { name: '放弃阶段', value: item.abandoned_stage_spend },
      { name: '无阶段', value: item.no_stage_spend },
    ],
  }));

  return (
    <div>
      {/* 你的页面布局已存在，只需要适配数据 */}
      {loading && <div>加载中...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      {/* 将 chartData 传递给图表组件 */}
    </div>
  );
};
```

**指定日期广告占比接口调用示例**:

```typescript
import { useState, useEffect } from 'react';
import { getAdRatioByDate } from '@/api'; // 根据实际路径调整

const AdRatioPage = () => {
  const [shop, setShop] = useState<string>(''); // 从页面选择器获取
  const [date, setDate] = useState<string>(''); // 从日期选择器获取，格式 YYYY-MM-DD
  const [loading, setLoading] = useState<boolean>(false);
  const [ratioData, setRatioData] = useState<{
    date: string;
    stages: {
      testing_stage: { spend: number };
      potential_stage: { spend: number };
      product_stage: {
        spend: number;
        sales_amount: number;
        roi: number;
      };
      abandoned_stage: { spend: number };
      no_stage: { spend: number };
    };
  } | null>(null);
  const [error, setError] = useState<string | null>(null);

  // 查询指定日期占比数据
  const fetchRatioData = async () => {
    if (!shop) {
      setError('请选择店铺');
      return;
    }

    if (!date) {
      setError('请选择日期');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const data = await getAdRatioByDate(shop, date);
      setRatioData(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : '查询失败');
      setRatioData(null);
    } finally {
      setLoading(false);
    }
  };

  // 当店铺或日期变化时自动查询（或手动触发）
  useEffect(() => {
    if (shop && date) {
      fetchRatioData();
    }
  }, [shop, date]); // 根据实际需求调整触发时机

  // 数据适配：提取各阶段数据
  const stageData = ratioData
    ? {
        testing: ratioData.stages.testing_stage.spend,
        potential: ratioData.stages.potential_stage.spend,
        product: {
          spend: ratioData.stages.product_stage.spend,
          sales: ratioData.stages.product_stage.sales_amount,
          roi: ratioData.stages.product_stage.roi,
        },
        abandoned: ratioData.stages.abandoned_stage.spend,
        noStage: ratioData.stages.no_stage.spend,
      }
    : null;

  return (
    <div>
      {/* 你的页面布局已存在，只需要适配数据 */}
      {loading && <div>加载中...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      {/* 将 stageData 传递给页面组件 */}
      {stageData && (
        <div>
          {/* 显示各阶段花费 */}
          <div>测款阶段花费: {stageData.testing}</div>
          <div>潜力阶段花费: {stageData.potential}</div>
          <div>成品阶段花费: {stageData.product.spend}</div>
          <div>成品阶段产出: {stageData.product.sales}</div>
          <div>成品阶段ROI: {stageData.product.roi}</div>
          <div>放弃阶段花费: {stageData.abandoned}</div>
          <div>无阶段花费: {stageData.noStage}</div>
        </div>
      )}
    </div>
  );
};
```

### 3. 数据格式化处理

**数字格式化**（可选，提升可读性）:

```typescript
/**
 * 格式化数字为货币格式（保留2位小数）
 */
export function formatCurrency(num: number): string {
  return num.toLocaleString('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

/**
 * 格式化ROI（保留2位小数）
 */
export function formatROI(roi: number): string {
  return roi.toFixed(2);
}

// 使用示例
const formattedSpend = formatCurrency(stageData.product.spend); // "500.80"
const formattedROI = formatROI(stageData.product.roi); // "2.99"
```

**日期格式化**（如果需要）:

```typescript
/**
 * 格式化日期显示（YYYY-MM-DD -> YYYY年MM月DD日）
 */
export function formatDateDisplay(dateStr: string): string {
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}年${month}月${day}日`;
}

// 使用示例
const displayDate = formatDateDisplay('2025-01-15'); // "2025年01月15日"
```

### 4. 错误处理

**完整的错误处理示例**:

```typescript
const fetchData = async () => {
  setLoading(true);
  setError(null);

  try {
    const data = await getAdTrend30Days(shop);
    setTrendData(data);
  } catch (err) {
    // 处理不同类型的错误
    if (err instanceof Error) {
      if (err.message.includes('网络')) {
        setError('网络连接失败，请检查网络后重试');
      } else if (err.message.includes('参数')) {
        setError('参数错误，请检查输入');
      } else {
        setError(err.message);
      }
    } else {
      setError('查询失败，请稍后重试');
    }
    setTrendData([]);
  } finally {
    setLoading(false);
  }
};
```

### 5. 数据适配到现有页面

**如果页面已经实现了布局，只需要将接口数据映射到现有组件**:

```typescript
// 假设页面已经有这些组件或变量
// - chartComponent: 图表组件
// - stageCards: 阶段卡片组件
// - summarySection: 汇总区域

// 30天趋势数据适配
useEffect(() => {
  if (trendData.length > 0) {
    // 适配到图表组件
    const chartOptions = {
      xAxis: {
        data: trendData.map((item) => item.date),
      },
      series: [
        {
          name: '测款阶段',
          data: trendData.map((item) => item.testing_stage_spend),
        },
        {
          name: '潜力阶段',
          data: trendData.map((item) => item.potential_stage_spend),
        },
        {
          name: '成品阶段',
          data: trendData.map((item) => item.product_stage_spend),
        },
        {
          name: '放弃阶段',
          data: trendData.map((item) => item.abandoned_stage_spend),
        },
      ],
    };
    // 更新图表组件
    chartComponent.setOption(chartOptions);
  }
}, [trendData]);

// 指定日期占比数据适配
useEffect(() => {
  if (ratioData) {
    // 适配到阶段卡片
    stageCards.updateData({
      testing: ratioData.stages.testing_stage.spend,
      potential: ratioData.stages.potential_stage.spend,
      product: {
        spend: ratioData.stages.product_stage.spend,
        sales: ratioData.stages.product_stage.sales_amount,
        roi: ratioData.stages.product_stage.roi,
      },
      abandoned: ratioData.stages.abandoned_stage.spend,
    });

    // 适配到汇总区域（只显示成品阶段数据）
    summarySection.updateData({
      spend: ratioData.stages.product_stage.spend,
      sales: ratioData.stages.product_stage.sales_amount,
      roi: ratioData.stages.product_stage.roi,
    });
  }
}, [ratioData]);
```

## 关键注意事项

### 1. URL 编码
- 使用 `encodeURIComponent()` 对店铺名称和日期进行编码，避免特殊字符问题

### 2. 日期格式
- 指定日期接口的 `date` 参数必须是 `YYYY-MM-DD` 格式
- 如果使用日期选择器，确保格式正确

### 3. 成品阶段特殊处理
- **只有成品阶段（product_stage）有 `sales_amount` 和 `roi` 字段**
- 其他阶段只有 `spend` 字段
- 在页面显示时要注意字段存在性检查

### 4. 数据为空处理
- 如果查询结果为空，30天趋势接口返回30条数据，所有花费为 0
- 指定日期接口返回各阶段花费为 0 的数据结构
- 需要在页面中处理空数据情况，显示友好提示

### 5. 加载状态
- 查询时显示 loading 状态
- 查询完成后隐藏 loading

### 6. 错误处理
- 网络错误：显示"网络连接失败，请检查网络后重试"
- 参数错误：显示后端返回的错误信息
- 数据为空：显示"暂无数据"提示

## 完整示例代码

### 30天趋势页面完整示例

```typescript
import React, { useState, useEffect } from 'react';
import { getAdTrend30Days } from '@/api';

interface TrendDataItem {
  date: string;
  testing_stage_spend: number;
  potential_stage_spend: number;
  product_stage_spend: number;
  abandoned_stage_spend: number;
  no_stage_spend: number;
}

const AdTrendPage: React.FC = () => {
  // 从页面已有的店铺选择器获取
  const [shop, setShop] = useState<string>('店铺名称');
  const [loading, setLoading] = useState<boolean>(false);
  const [trendData, setTrendData] = useState<TrendDataItem[]>([]);
  const [error, setError] = useState<string | null>(null);

  const fetchData = async () => {
    if (!shop) {
      setError('请选择店铺');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const data = await getAdTrend30Days(shop);
      setTrendData(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : '查询失败');
      setTrendData([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (shop) {
      fetchData();
    }
  }, [shop]);

  // 数据适配：转换为图表所需格式
  const chartData = trendData.map((item) => ({
    date: item.date,
    values: {
      testing: item.testing_stage_spend,
      potential: item.potential_stage_spend,
      product: item.product_stage_spend,
      abandoned: item.abandoned_stage_spend,
      noStage: item.no_stage_spend,
    },
  }));

  return (
    <div>
      {/* 你的页面布局已存在 */}
      {loading && <div>加载中...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      {!loading && !error && trendData.length === 0 && (
        <div>暂无数据</div>
      )}
      {/* 将 chartData 传递给你的图表组件 */}
    </div>
  );
};

export default AdTrendPage;
```

### 指定日期占比页面完整示例

```typescript
import React, { useState, useEffect } from 'react';
import { getAdRatioByDate } from '@/api';

interface RatioData {
  date: string;
  stages: {
    testing_stage: { spend: number };
    potential_stage: { spend: number };
    product_stage: {
      spend: number;
      sales_amount: number;
      roi: number;
    };
    abandoned_stage: { spend: number };
    no_stage: { spend: number };
  };
}

const AdRatioPage: React.FC = () => {
  // 从页面已有的选择器获取
  const [shop, setShop] = useState<string>('店铺名称');
  const [date, setDate] = useState<string>('2025-01-15'); // YYYY-MM-DD 格式
  const [loading, setLoading] = useState<boolean>(false);
  const [ratioData, setRatioData] = useState<RatioData | null>(null);
  const [error, setError] = useState<string | null>(null);

  const fetchData = async () => {
    if (!shop) {
      setError('请选择店铺');
      return;
    }

    if (!date) {
      setError('请选择日期');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const data = await getAdRatioByDate(shop, date);
      setRatioData(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : '查询失败');
      setRatioData(null);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (shop && date) {
      fetchData();
    }
  }, [shop, date]);

  return (
    <div>
      {/* 你的页面布局已存在 */}
      {loading && <div>加载中...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      {!loading && !error && ratioData && (
        <div>
          {/* 将 ratioData.stages 传递给你的页面组件 */}
          <div>日期: {ratioData.date}</div>
          <div>测款阶段花费: {ratioData.stages.testing_stage.spend}</div>
          <div>潜力阶段花费: {ratioData.stages.potential_stage.spend}</div>
          <div>成品阶段花费: {ratioData.stages.product_stage.spend}</div>
          <div>成品阶段产出: {ratioData.stages.product_stage.sales_amount}</div>
          <div>成品阶段ROI: {ratioData.stages.product_stage.roi}</div>
          <div>放弃阶段花费: {ratioData.stages.abandoned_stage.spend}</div>
          <div>无阶段花费: {ratioData.stages.no_stage.spend}</div>
        </div>
      )}
    </div>
  );
};

export default AdRatioPage;
```

## 测试要点

1. **参数验证**：测试店铺为空、日期为空的情况
2. **数据格式**：验证返回数据的格式是否正确
3. **空数据处理**：测试没有数据时的显示
4. **错误处理**：测试网络错误、接口错误的处理
5. **数据适配**：验证数据是否正确适配到页面组件
6. **成品阶段特殊字段**：验证只有成品阶段有 `sales_amount` 和 `roi` 字段

## 总结

1. **封装 API 调用函数**：在 `api.ts` 或 `services.ts` 中封装两个接口调用函数
2. **在组件中调用**：使用 `useState` 和 `useEffect` 管理状态和调用时机
3. **数据适配**：将接口返回的数据格式转换为页面组件所需的格式
4. **错误处理**：添加完整的错误处理和加载状态
5. **数据格式化**：可选，添加数字和日期的格式化函数提升可读性

页面布局已存在，只需要按照上述说明实现接口调用和数据适配即可。

